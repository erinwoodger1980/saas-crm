# Component Library System

## Overview

The Component Library System enables **component reusability across products**. When you update a component's profile (e.g., a window cill), the change propagates to all products using that component.

## Architecture

### Database Schema

**ComponentLookup** - Reusable component definitions
```prisma
model ComponentLookup {
  id              String   @id @default(uuid())
  tenantId        String
  productTypes    String[] // Which products use this component
  componentType   String   // STILE, RAIL, MULLION, etc.
  code            String   // Unique identifier (e.g., "STILE_60x45")
  name            String   // Display name
  description     String?
  basePrice       Float    @default(0)
  profile         ComponentProfile?
  metadata        Json?    // { widthMm, depthMm, autoGenerated }
  supplierId      String?
  supplier        Supplier?
}
```

**ComponentProfile** - SVG cross-section geometry
```prisma
model ComponentProfile {
  id              String   @id @default(uuid())
  componentId     String   @unique
  component       ComponentLookup @relation(fields: [componentId])
  profileType     String   // CUSTOM, STANDARD, etc.
  dimensions      Json     // { widthMm, depthMm }
  geometry        Json     // { svg: "...", type: "..." }
}
```

### Component Matching Algorithm

When AI estimates components from images/descriptions:

1. **Exact Match**: Find existing component with same `componentType` + dimensions
2. **Reuse**: Return existing `componentLookupId` and `profileId`
3. **Create New**: If no match, create new ComponentLookup + ComponentProfile
4. **Auto-tag**: Mark with `autoGenerated: true` in metadata

```typescript
// Example: AI detects a 60mm × 45mm stile
const matchResult = await findOrCreateComponent(
  tenantId,
  'STILE',           // componentType
  'Left Stile',      // label
  60,                // widthMm
  45,                // depthMm
  'WINDOW'           // productCategory
);

// Returns:
{
  componentId: "uuid-of-component",
  profileId: "uuid-of-profile",
  component: { code: "STILE_60x45", name: "Left Stile", ... },
  profile: { geometry: { svg: "...", type: "stile" }, ... }
}
```

## AI Component Estimation

### Endpoint

```
POST /api/ai/estimate-components
```

**Request:**
```typescript
{
  productType: {
    category: 'WINDOW',
    type: 'CASEMENT',
    option: 'SINGLE'
  },
  dimensions: {
    widthMm: 1200,
    heightMm: 1500,
    depthMm: 45
  },
  description?: string,
  imageBase64?: string  // or file upload
}
```

**Response:**
```typescript
{
  components: [
    {
      id: "component-xyz",
      type: "stile",
      label: "Left Stile",
      componentLookupId: "uuid-123",  // Reference to ComponentLookup
      geometry: { width: 60, height: 1500, depth: 45 },
      position: { x: -600, y: 0, z: 0 },
      material: "timber",
      profile: {
        suggested: "60mm Stile Profile",
        widthMm: 60,
        depthMm: 45,
        svg: "<svg>...</svg>",
        profileId: "profile-uuid"  // Reference to ComponentProfile
      },
      confidence: 0.9
    }
  ],
  reasoning: "Analysis of casement window structure...",
  confidence: 0.85,
  suggestions: ["Consider adding weather seals"]
}
```

### SVG Profile Generation

Each component type gets realistic SVG cross-sections:

- **Stiles** (vertical frames): Rebates for glass + weather seals
- **Rails** (horizontal frames): Chamfered edges
- **Mullions/Transoms** (dividers): Central grooves
- **Glazing Bars**: Narrow beveled profiles
- **Panels**: Raised panel effects

```typescript
const profile = generateEstimatedProfile('stile', 60, 45);
// Returns: { name: "60mm Stile Profile", svg: "<svg>...</svg>" }
```

## Frontend UI

### Component Library Section

Located in Settings → Products → Component Library

**Features:**
- ✅ Search and filter components
- ✅ View all components with profile previews
- ✅ Edit component details (name, dimensions, price)
- ✅ See which products use each component
- ✅ Duplicate components
- ✅ Delete components (with warnings)
- ✅ AI-generated components marked with badge

**Key UX:**
```tsx
<ComponentLibrarySection />
```

Shows table with:
- Code (e.g., `STILE_60x45`)
- Name
- Type badge
- Profile preview (SVG thumbnail)
- "Used In" product type badges
- Price
- Actions (Edit, Duplicate, Delete)

### Product Types Integration

When using AI Estimate:

1. Click **✨ AI Estimate** button
2. Upload image or enter description
3. AI analyzes and matches/creates components
4. Components stored in library with `autoGenerated: true`
5. Product template references `componentLookupId` instead of inline geometry

## Component Reusability

### Before (Inline Components)

```json
{
  "productTypes": {
    "WINDOW": {
      "CASEMENT": {
        "sceneConfig": {
          "components": [
            {
              "geometry": { "width": 60, "height": 1500, "depth": 45 },
              "profile": { "svg": "..." }
            }
          ]
        }
      }
    }
  }
}
```

**Problem**: Updating stile profile requires editing every window type manually.

### After (Component Library)

```json
{
  "productTypes": {
    "WINDOW": {
      "CASEMENT": {
        "sceneConfig": {
          "components": [
            {
              "componentLookupId": "uuid-123",
              "overrides": {}
            }
          ]
        }
      }
    }
  }
}
```

**Benefit**: Update component in library → all products using it update automatically.

### Propagation Workflow

1. Edit component in Component Library section
2. Update profile dimensions (e.g., change stile from 60mm to 70mm)
3. Save changes
4. All products with `componentLookupId: "uuid-123"` now use new profile
5. 3D configurator resolves references at render time

## API Routes

### GET /api/components
List all components for tenant

### POST /api/components
Create new component

```typescript
{
  componentType: "STILE",
  code: "STILE_70x50",
  name: "70mm Stile",
  productTypes: ["WINDOW", "DOOR"],
  basePrice: 12.50,
  metadata: { widthMm: 70, depthMm: 50 },
  profile: {
    profileType: "CUSTOM",
    dimensions: { widthMm: 70, depthMm: 50 },
    geometry: { svg: "...", type: "stile" }
  }
}
```

### PATCH /api/components/:id
Update component (propagates to all products)

### DELETE /api/components/:id
Delete component (warns if used in products)

## Migration Strategy

### Existing Products
- Continue to work with inline components
- Gradually migrate to component library

### New Products
- AI Estimate automatically uses component library
- Manual builds can select from library

### Best Practices
1. Use AI Estimate to build component library automatically
2. Review and refine auto-generated components
3. Standardize component codes (e.g., `STILE_60x45`, `RAIL_50x40`)
4. Add supplier links for costing
5. Set realistic base prices
6. Merge duplicate components

## Example Workflow

### 1. AI Generates Components
```bash
POST /api/ai/estimate-components
{
  "productType": { "category": "WINDOW", "type": "CASEMENT" },
  "dimensions": { "widthMm": 1200, "heightMm": 1500 },
  "description": "Standard casement window with two vertical stiles"
}
```

**Result**: Creates `STILE_60x45` component in library

### 2. Reuse in Another Product
```bash
POST /api/ai/estimate-components
{
  "productType": { "category": "WINDOW", "type": "SASH" },
  "dimensions": { "widthMm": 1000, "heightMm": 1800 }
}
```

**Result**: Detects existing `STILE_60x45`, reuses same component

### 3. Update Component Profile
Navigate to Settings → Component Library
- Find `STILE_60x45`
- Edit dimensions to 70mm × 50mm
- Update profile SVG
- Save

**Result**: Both CASEMENT and SASH windows now use 70mm stiles

## Benefits

✅ **Consistency**: Same component across all products  
✅ **Efficiency**: Update once, propagate everywhere  
✅ **Costing**: Link components to suppliers for accurate pricing  
✅ **ML Training**: Standardized components improve AI accuracy  
✅ **BOM Generation**: Automatic bill of materials from component references  
✅ **Variant Management**: Create component variants (e.g., painted vs. stained)

## Technical Notes

### Performance
- Component resolution happens at render time
- Profiles cached in browser after first load
- Database queries optimized with indexes on `componentType` + `code`

### Validation
- Prevents duplicate codes per tenant
- Warns when deleting components used in products
- Validates profile dimensions match component metadata

### Future Enhancements
- [ ] Bulk import from CSV
- [ ] Component families (grouped stiles, rails, etc.)
- [ ] Profile editor with visual SVG builder
- [ ] Component marketplace for sharing across tenants
- [ ] Version history for profile changes
