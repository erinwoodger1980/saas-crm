services:
  # ===== PRODUCTION SERVICES =====
  - type: web
    name: api
    env: node
    rootDir: api
    branch: main  # Only deploy from main branch
    buildCommand: corepack enable && pnpm i --frozen-lockfile && pnpm run build
    startCommand: pnpm run start
    preDeployCommand: pnpm run prisma:deploy:safe && pnpm tsx scripts/update-wealden-landing-prod.ts || true
    healthCheckPath: /health
    plan: starter
    autoDeploy: false  # Disable auto-deploy - only deploy via GitHub Actions when both CI pass
    envVars:
      - key: ML_URL
        value: https://new-ml-zo9l.onrender.com
      - key: ML_TIMEOUT_MS
        value: 8000
      - key: TEMPLATE_TENANT_NAME
        value: Demo Tenant
      - key: PUPPETEER_SKIP_DOWNLOAD
        value: "1"
      - key: SKIP_PRISMA_POSTINSTALL
        value: "1"
  
  - type: web
    name: web
    env: node
    rootDir: web
    branch: main  # Only deploy from main branch
    buildCommand: corepack enable && pnpm i --frozen-lockfile && pnpm run build
    startCommand: pnpm run start
    healthCheckPath: /health
    plan: starter
    autoDeploy: false  # Disable auto-deploy - only deploy via GitHub Actions when both CI pass
    envVars:
      - key: NODE_ENV
        value: production
      - key: API_ORIGIN
        value: https://api.joineryai.app
      - key: NEXT_PUBLIC_API_BASE
        value: https://api.joineryai.app
      - key: NEXT_PUBLIC_WEB_ORIGIN
        value: https://www.joineryai.app
      - key: NEXT_PUBLIC_FOUNDERS_PROMO_CODE
        sync: false  # Set this in Render dashboard (optional)
      - key: NEXT_PUBLIC_DISCOUNT_DEADLINE
        sync: false  # Set this in Render dashboard (optional)
      - key: NEXT_PUBLIC_STRIPE_CHECKOUT_URL_MONTHLY
        sync: false  # Set this in Render dashboard (optional)
      - key: NEXT_PUBLIC_STRIPE_CHECKOUT_URL_ANNUAL
        sync: false  # Set this in Render dashboard (optional)
  
  # ===== STAGING SERVICES =====
  - type: web
    name: api-staging
    env: node
    rootDir: api
    branch: staging  # Auto-deploy from staging branch
    buildCommand: corepack enable && pnpm i --frozen-lockfile && pnpm run build
    startCommand: pnpm run start
    preDeployCommand: npx prisma migrate deploy --schema=./prisma/schema.prisma
    healthCheckPath: /health
    plan: starter
    autoDeploy: true  # Auto-deploy staging when staging branch updates
    envVars:
      - key: NODE_ENV
        value: staging
      - key: ML_URL
        value: https://new-ml-zo9l.onrender.com
      - key: ML_TIMEOUT_MS
        value: 8000
      - key: TEMPLATE_TENANT_NAME
        value: Demo Tenant
      - key: PUPPETEER_SKIP_DOWNLOAD
        value: "1"
      - key: SKIP_PRISMA_POSTINSTALL
        value: "1"
      - key: DATABASE_URL
        sync: false  # Set to staging database in Render dashboard
  
  - type: web
    name: web-staging
    env: node
    rootDir: web
    branch: staging  # Auto-deploy from staging branch
    buildCommand: corepack enable && pnpm i --frozen-lockfile && pnpm run build
    startCommand: pnpm run start
    healthCheckPath: /health
    plan: starter
    autoDeploy: true  # Auto-deploy staging when staging branch updates
    envVars:
      - key: NODE_ENV
        value: staging
      - key: API_ORIGIN
        sync: false  # Set to https://api-staging.joineryai.app in Render dashboard
      - key: NEXT_PUBLIC_API_BASE
        sync: false  # Set to https://api-staging.joineryai.app in Render dashboard
      - key: NEXT_PUBLIC_WEB_ORIGIN
        sync: false  # Set to https://staging.joineryai.app in Render dashboard
  - type: web
    name: ml
    env: docker
    rootDir: ml
    dockerfilePath: ./Dockerfile
    envVars:
      - key: DATABASE_URL
        sync: false  # Set this in Render dashboard to your PostgreSQL URL
      - key: API_SERVICE_URL
        value: https://api.joineryai.app
      - key: PORT
        value: 8000
