name: Deploy to Production

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "âŒ Deployment cancelled - confirmation not provided"
            exit 1
          fi
          echo "âœ… Deployment confirmed"

      - name: Check branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "âŒ Production deployments must be from main branch"
            exit 1
          fi
          echo "âœ… Deploying from main branch"

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Trigger Render Deploy - API
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID || vars.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸš€ Triggering API deployment via Render API..."
          if [ -z "${RENDER_API_KEY}" ] || [ -z "${RENDER_SERVICE_ID}" ]; then
            echo "âš ï¸  Missing Render secrets (RENDER_API_KEY/RENDER_SERVICE_ID). Skipping API deploy."
          else
            curl -sS -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache":"clear"}'
            echo "âœ… API deployment request sent"
          fi
          
      - name: Trigger Render Deploy - Web (optional)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_WEB_SERVICE_ID: ${{ secrets.RENDER_WEB_SERVICE_ID || vars.RENDER_WEB_SERVICE_ID }}
        run: |
          echo "ðŸŒ Triggering Web deployment via Render API..."
          if [ -z "${RENDER_API_KEY}" ] || [ -z "${RENDER_WEB_SERVICE_ID}" ]; then
            echo "â„¹ï¸  Missing Render web service id; skipping web deploy."
          else
            curl -sS -X POST "https://api.render.com/v1/services/${RENDER_WEB_SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache":"clear"}'
            echo "âœ… Web deployment request sent"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Production Deployment Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Services Deploying:" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://api.joineryai.app" >> $GITHUB_STEP_SUMMARY
          echo "- Web: https://joineryai.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor deployment progress in the [Render Dashboard](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
