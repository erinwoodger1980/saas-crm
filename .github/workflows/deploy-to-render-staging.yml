name: deploy-to-render-staging

on:
  workflow_run:
    workflows: ["api-ci", "web-ci"]
    types: [completed]
    branches: [staging]

jobs:
  check-and-deploy-staging:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      RENDER_WEB_SERVICE_ID: ${{ secrets.RENDER_WEB_SERVICE_ID_STAGING || vars.RENDER_WEB_SERVICE_ID_STAGING || '' }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_STAGING || vars.RENDER_SERVICE_ID_STAGING || '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Ensure staging service IDs are set
        run: |
          if [ -z "$RENDER_SERVICE_ID" ]; then
            echo "âŒ RENDER_SERVICE_ID_STAGING not set (secret or repo variable)" >&2
            exit 1
          fi
          echo "Using API service: $RENDER_SERVICE_ID"
          if [ -n "$RENDER_WEB_SERVICE_ID" ]; then
            echo "Using WEB service: $RENDER_WEB_SERVICE_ID"
          else
            echo "No staging WEB service ID provided; will skip web deploy"
          fi

      - name: Check both workflows passed
        id: check_workflows
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            const repo = context.repo;

            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: repo.owner,
              repo: repo.repo,
              head_sha: sha,
              per_page: 100
            });

            const apiCiRun = workflowRuns.workflow_runs
              .filter(run => run.name === 'api-ci' && run.head_sha === sha)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

            const webCiRun = workflowRuns.workflow_runs
              .filter(run => run.name === 'web-ci' && run.head_sha === sha)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

            const apiPassed = apiCiRun && apiCiRun.conclusion === 'success';
            const webPassed = webCiRun && webCiRun.conclusion === 'success';

            if (!apiCiRun || !webCiRun) {
              core.setOutput('should_deploy', 'false');
              core.setOutput('reason', 'waiting');
              return;
            }

            if (apiPassed && webPassed) {
              core.setOutput('should_deploy', 'true');
              core.setOutput('reason', 'both_passed');
            } else {
              core.setOutput('should_deploy', 'false');
              core.setOutput('reason', 'failed');
              core.setFailed(`Deployment blocked: api-ci=${apiCiRun?.conclusion || 'not found'}, web-ci=${webCiRun?.conclusion || 'not found'}`);
            }

      - name: Trigger Render API deployment (staging)
        if: steps.check_workflows.outputs.should_deploy == 'true'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY_STAGING || secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ env.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸš€ Triggering staging API deployment..."
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "clear"}'
          echo "âœ… Staging API deployment triggered"

      - name: Trigger Render WEB deployment (staging)
        if: steps.check_workflows.outputs.should_deploy == 'true' && env.RENDER_WEB_SERVICE_ID != ''
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY_STAGING || secrets.RENDER_API_KEY }}
          RENDER_WEB_SERVICE_ID: ${{ env.RENDER_WEB_SERVICE_ID }}
        run: |
          echo "ðŸŒ Triggering staging WEB deployment..."
          curl -X POST "https://api.render.com/v1/services/${RENDER_WEB_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "clear"}'
          echo "âœ… Staging WEB deployment triggered"

      - name: Deployment summary
        if: always()
        run: |
          echo "## Staging Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_workflows.outputs.should_deploy }}" == "true" ]; then
            echo "âœ… **Result:** Staging deploy triggered" >> $GITHUB_STEP_SUMMARY
          else
            echo "â³/âŒ **Result:** skipped (reason: ${{ steps.check_workflows.outputs.reason || 'unknown' }})" >> $GITHUB_STEP_SUMMARY
          fi