name: deploy-to-render

on:
  workflow_run:
    workflows: ["api-ci", "web-ci"]
    types: [completed]
    branches: [main]

jobs:
  check-and-deploy:
    # Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      # Make web service id available for if: expressions (masked). Using env here avoids
      # referencing the `secrets` context directly in an `if`, which GitHub disallows in some scopes.
      RENDER_WEB_SERVICE_ID: ${{ secrets.RENDER_WEB_SERVICE_ID }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Check both workflows passed
        id: check_workflows
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            const repo = context.repo;
            
            console.log(`Checking workflows for commit ${sha}`);
            
            // Get all workflow runs for this commit
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: repo.owner,
              repo: repo.repo,
              head_sha: sha,
              per_page: 100
            });
            
            // Find the most recent run of each workflow
            const apiCiRun = workflowRuns.workflow_runs
              .filter(run => run.name === 'api-ci' && run.head_sha === sha)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
            
            const webCiRun = workflowRuns.workflow_runs
              .filter(run => run.name === 'web-ci' && run.head_sha === sha)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
            
            console.log('api-ci status:', apiCiRun?.conclusion || 'not found');
            console.log('web-ci status:', webCiRun?.conclusion || 'not found');
            
            // Check if both workflows completed successfully
            const apiPassed = apiCiRun && apiCiRun.conclusion === 'success';
            const webPassed = webCiRun && webCiRun.conclusion === 'success';
            
            if (!apiCiRun || !webCiRun) {
              console.log('â³ Waiting for both workflows to complete...');
              core.setOutput('should_deploy', 'false');
              core.setOutput('reason', 'waiting');
              return;
            }
            
            if (apiPassed && webPassed) {
              console.log('âœ… Both workflows passed! Ready to deploy.');
              core.setOutput('should_deploy', 'true');
              core.setOutput('reason', 'both_passed');
            } else {
              console.log('âŒ One or both workflows failed. Skipping deployment.');
              core.setOutput('should_deploy', 'false');
              core.setOutput('reason', 'failed');
            }

      - name: Check for duplicate deployment
        id: check_duplicate
        if: steps.check_workflows.outputs.should_deploy == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            const repo = context.repo;
            
            // Check if a deploy workflow has already succeeded for this commit
            const { data: deployRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: repo.owner,
              repo: repo.repo,
              workflow_id: 'deploy-to-render.yml',
              head_sha: sha,
              status: 'completed',
              per_page: 100
            });
            
            const successfulDeploys = deployRuns.workflow_runs.filter(
              run => run.conclusion === 'success' && run.id !== ${{ github.run_id }}
            );
            
            if (successfulDeploys.length > 0) {
              console.log('ðŸ”„ Deployment already completed for this commit. Skipping.');
              core.setOutput('skip_deploy', 'true');
            } else {
              console.log('ðŸš€ No previous successful deployment found. Proceeding.');
              core.setOutput('skip_deploy', 'false');
            }

      - name: Trigger Render API deployment (migrations)
        if: |
          steps.check_workflows.outputs.should_deploy == 'true' &&
          steps.check_duplicate.outputs.skip_deploy == 'false'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸš€ Triggering Render deployment..."
          
          # Trigger deployment via Render API
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"clearCache\": \"clear\"}"
          
          echo "âœ… Deployment triggered successfully!"

      - name: Trigger Render WEB deployment (optional)
        if: |
          steps.check_workflows.outputs.should_deploy == 'true' &&
          steps.check_duplicate.outputs.skip_deploy == 'false' &&
          env.RENDER_WEB_SERVICE_ID != ''
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_WEB_SERVICE_ID: ${{ env.RENDER_WEB_SERVICE_ID }}
        run: |
          echo "ðŸŒ Triggering Render WEB deployment (optional) ..."

          # Trigger deployment of the Web service if service id is provided
          curl -X POST "https://api.render.com/v1/services/${RENDER_WEB_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"clearCache\": \"clear\"}"

          echo "âœ… WEB deployment triggered (if service id was set)."

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_workflows.outputs.should_deploy }}" == "true" ] && [ "${{ steps.check_duplicate.outputs.skip_deploy }}" == "false" ]; then
            echo "âœ… **Result:** API deployment triggered to Render" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ secrets.RENDER_WEB_SERVICE_ID }}" ]; then
              echo "ðŸŒ **Web:** Web deployment also triggered" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ **Web:** Skipped (set RENDER_WEB_SERVICE_ID secret to auto-deploy web)" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ steps.check_duplicate.outputs.skip_deploy }}" == "true" ]; then
            echo "ðŸ”„ **Result:** Skipped (already deployed for this commit)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_workflows.outputs.reason }}" == "waiting" ]; then
            echo "â³ **Result:** Waiting for all workflows to complete" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Result:** Deployment skipped (one or both CI workflows failed)" >> $GITHUB_STEP_SUMMARY
          fi
