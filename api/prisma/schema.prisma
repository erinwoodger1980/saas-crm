generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                         String                      @id @default(cuid())
  name                       String
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @default(now()) @updatedAt
  stripeCustomerId           String?                     @unique
  stripeSubscriptionId       String?                     @unique
  trialEndsAt                DateTime?
  discountCodeUsed           String?
  seatsOffice                Int                         @default(5)
  seatsWorkshop              Int                         @default(10)
  seatsDisplay               Int                         @default(2)
  subscriptionStatus         SubscriptionStatus?
  plan                       Plan?
  financialYearEnd           String?                     @default("12-31")
  keywords                   String[]                    @default([])
  serviceAreas               String[]                    @default([])
  homeUrl                    String?
  googleAdsCustomerId        String?
  googleAdsRefreshToken      String?
  targetCPL                  Decimal?                    @default(50)
  slug                       String                      @unique
  isGroupCoachingMember      Boolean                     @default(false)
  geofenceEnabled            Boolean                     @default(false)
  geofenceLatitude           Float?
  geofenceLongitude          Float?
  geofenceRadiusMeters       Float?                      @default(100)
  activityLogs               ActivityLog[]
  automationRules            AutomationRule[]
  clients                    Client[]
  clientAccounts             ClientAccount[]
  doorCores                  DoorCore[]
  emailIngests               EmailIngest[]
  emailMessages              EmailMessage[]
  emailThreads               EmailThread[]
  emailConversations         EmailConversation[]
  examplePhotos              ExamplePhoto[]
  followUpRules              FollowUpRule[]
  followUpHistories          FollowUpHistory[]
  featureRequests            FeatureRequest[]
  feedbacks                  Feedback[]
  fireCertificationRules     FireCertificationRule[]
  clientJobs                 FireDoorClientJob[]
  fireDoorProductionLogs     FireDoorProductionLog[]
  fireDoorScheduleProjects   FireDoorScheduleProject[]
  followUpEvents             FollowUpEvent[]
  followUpTemplates          FollowUpTemplate[]
  formTemplates              FormTemplate[]
  frameFinishes              FrameFinish[]
  glazingItems               GlazingItem[]
  GmailTenantConnection      GmailTenantConnection?
  gmailUserConnections       GmailUserConnection[]       @relation("GmailUserConnections")
  holidays                   Holiday[]
  ironmongeryItems           IronmongeryItem[]
  ironmongeryPacks           IronmongeryPack[]
  keywordPerformance         KeywordPerformance[]
  keywordSuggestions         KeywordSuggestion[]
  landingTenant              LandingTenant?
  leads                      Lead[]
  leadFieldDefs              LeadFieldDef[]
  leadVisionInferences       LeadVisionInference[]
  leafFacings                LeafFacing[]
  leafSizingRules            LeafSizingRule[]
  leafStyles                 LeafStyle[]
  materials                  Material[]
  materialItems              MaterialItem[]
  modelOverrides             ModelOverride[]
  Ms365TenantConnection      Ms365TenantConnection?
  ms365UserConnections       Ms365UserConnection[]       @relation("Ms365UserConnections")
  notifications              Notification[]
  opportunities              Opportunity[]
  processPlans               ProcessPlan[]
  projectProcessAssignments  ProjectProcessAssignment[]
  purchaseOrders             PurchaseOrder[]
  questionnaires             Questionnaire[]
  questionnaireFields        QuestionnaireField[]
  questionnairePhotos        QuestionnairePhoto[]
  questionnaireResponses     QuestionnaireResponse[]
  quotes                     Quote[]
  quoteQuestionnaireMatches  QuoteQuestionnaireMatch[]
  shoppingLists              ShoppingList[]
  softwareProfiles           SoftwareProfile[]           @relation("SoftwareProfiles")
  sourceSpends               SourceSpend[]
  sprayFinishes              SprayFinish[]
  streaks                    Streak[]
  suppliers                  Supplier[]                  @relation("SupplierToTenant")
  supplierQuoteRequests      SupplierQuoteRequest[]
  targets                    Target[]
  tasks                      Task[]
  taskTemplates              TaskTemplate[]
  timeEntries                TimeEntry[]
  timesheets                 Timesheet[]
  trainingEvents             TrainingEvent[]
  trainingInsights           TrainingInsights[]
  UploadedFile               UploadedFile[]
  users                      User[]
  userPreferences            UserPreference[]
  veneerLayons               VeneerLayon[]
  weightLookups              WeightLookup[]
  workshopProcessDefinitions WorkshopProcessDefinition[]
  workshopTimers             WorkshopTimer[]
  taskFieldLinks             TaskFieldLink[]
  analyticsEvents            AnalyticsEvent[]
  goalPlans                  GoalPlan[]
  financialPlans             FinancialPlan[]
  fireDoorProcessQRConfigs   FireDoorProcessQRConfig[]   @relation("FireDoorProcessQRConfigs")
  fireDoorQRScans            FireDoorQRScan[]            @relation("FireDoorQRScans")
  fireDoorMaintenanceRecords FireDoorMaintenanceRecord[] @relation("FireDoorMaintenanceRecords")
  lippingLookups             LippingLookup[]             @relation("LippingLookups")
  componentLookups           ComponentLookup[]           @relation("ComponentLookups")
  productTypeComponents      ProductTypeComponent[]      @relation("ProductTypeComponents")
  projects                   Project[]                   @relation("TenantProjects")
  processTimingPredictions   ProcessTimingPrediction[]   @relation("TenantProcessTimings")
  processCostRates           ProcessCostRate[]           @relation("TenantProcessCostRates")
  componentAttributes        ComponentAttribute[]        @relation("ComponentAttributes")
  componentVariants          ComponentVariant[]          @relation("ComponentVariants")
  productTypes               ProductType[]               @relation("TenantProductTypes")
  attributes                 Attribute[]                 @relation("TenantAttributes")
  questions                  Question[]                  @relation("TenantQuestions")
  questionSets               QuestionSet[]               @relation("TenantQuestionSets")
  legacyQuestionMappings     LegacyQuestionMapping[]     @relation("TenantLegacyMappings")
  standardFieldMappings      StandardFieldMapping[]      @relation("TenantStandardFieldMappings")
  sceneStates                SceneState[]
  lookupTables               LookupTable[]               @relation("LookupTables")
  fieldDisplayContexts       FieldDisplayContext[]       @relation("FieldDisplayContexts")
  componentTemplates         ComponentTemplate[]         @relation("ComponentTemplates")
  mlTrainingEvents           MLTrainingEvent[]           @relation("MLTrainingEvents")
  architectPacks             ArchitectPack[]             @relation("ArchitectPacks")
  tenantAIUsageEvents        TenantAIUsageEvent[]        @relation("TenantAIUsageEvents")
  tenantAIUsageMonthly       TenantAIUsageMonthly[]      @relation("TenantAIUsageMonthly")
  holidayRequests            HolidayRequest[]
  productTypeComponentAssignments ProductTypeComponentAssignment[] @relation("ProductTypeComponentAssignmentsTenant")
  profiles                   Profile[]                   @relation("TenantProfiles")
  accountingConnections      TenantAccountingConnection[] @relation("AccountingConnections")
  accountingDocuments        AccountingDocument[]        @relation("AccountingDocuments")
  monthlyWageBills           MonthlyWageBill[]           @relation("MonthlyWageBills")
  monthlyProjectMetrics      MonthlyProjectMetrics[]     @relation("MonthlyProjectMetrics")
  fireDoorRFIs               FireDoorRFI[]               @relation("TenantFireDoorRFIs")
}

model LippingLookup {
  id               String   @id @default(cuid())
  tenantId         String
  doorsetType      String // e.g., "STANDARD CONCEALED", "D/A 44", "SAFEHINGE 54"
  topMm            Int? // Top edge lipping thickness in mm
  bottomMm         Int? // Bottom edge lipping thickness in mm
  hingeMm          Int? // Hinge side lipping thickness in mm
  lockMm           Int? // Lock side lipping thickness in mm
  safeHingeMm      Int? // Safe hinge lipping thickness in mm
  daExposedMm      Int? // D/A exposed lipping thickness in mm
  trimMm           Int? // Trim lipping thickness in mm
  postformedMm     Int? // Postformed lipping thickness in mm
  extrasMm         Int? // Extra lipping thickness in mm
  commentsForNotes String? // Additional notes/comments
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tenant           Tenant   @relation("LippingLookups", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, doorsetType])
  @@index([tenantId, isActive])
}

enum BOMStatus {
  DRAFT
  PENDING_ORDER
  ORDERED
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

model ComponentLookup {
  id              String   @id @default(cuid())
  tenantId        String
  productTypes    String[] @default([]) // Which products this component works with (e.g., ["FIRE_DOOR", "STANDARD_DOOR", "CUSTOM_PRODUCT"])
  componentType   String // Flexible component type (e.g., "LIPPING", "HINGE", tenant custom types)
  code            String // Unique component code (e.g., "LIPT25", "HNG-BT-SS")
  name            String // Display name
  description     String? // Detailed description
  unitOfMeasure   String   @default("EA") // EA, M, MM, KG, L, etc.
  basePrice       Float    @default(0)
  leadTimeDays    Int      @default(0)
  supplierId      String? // Reference to supplier by ID
  isActive        Boolean  @default(true)
  metadata        Json? // Flexible storage for component-specific data (dimensions, specs, etc.)
  inclusionRules  Json? // JSON rules for when component is included based on configuredProduct.selections
  quantityFormula String? // Formula to calculate quantity based on dimensions and selections
  
  // Parametric positioning and sizing (formulas can reference other components, product dimensions)
  positionXFormula String? // e.g., "frameWidth + gap"
  positionYFormula String? // e.g., "0"
  positionZFormula String? // e.g., "product.height - railHeight - gap"
  widthFormula     String? // e.g., "product.width - frameWidth * 2 - stileWidth * 2 + tennonLength * 2"
  heightFormula    String? // e.g., "railHeight"
  depthFormula     String? // e.g., "doorThickness"
  
  // Material and Profile references for rendering and manufacturing
  materialId       String? // Reference to Material for display/rendering
  bodyProfileId    String? // Main profile shape for component body
  startEndProfileId String? // Profile for start end (tenon/shoulder machining)
  endEndProfileId   String? // Profile for end end (tenon/shoulder machining)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant             Tenant                @relation("ComponentLookups", fields: [tenantId], references: [id], onDelete: Cascade)
  supplier           Supplier?             @relation("SupplierComponents", fields: [supplierId], references: [id])
  material           Material?             @relation("ComponentMaterial", fields: [materialId], references: [id])
  bodyProfile        Profile?              @relation("ComponentBodyProfile", fields: [bodyProfileId], references: [id])
  startEndProfile    Profile?              @relation("ComponentStartEndProfile", fields: [startEndProfileId], references: [id])
  endEndProfile      Profile?              @relation("ComponentEndEndProfile", fields: [endEndProfileId], references: [id])
  profile            ComponentProfile?     @relation("ComponentProfile")
  bomLineItems       BOMLineItem[]         @relation("ComponentBOMItems")
  componentProcesses ComponentProcess[]    @relation("ComponentProcesses")
  variants           ComponentVariant[]    @relation("ComponentVariants")
  fields             QuestionnaireField[]  @relation("FieldComponentLookup")
  productTypeAssignments ProductTypeComponentAssignment[] @relation("ComponentProductTypeAssignments")
  componentTemplates ComponentTemplate[]   @relation("TemplateComponentLookup")
  
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([componentType])
  @@index([supplierId])
  @@index([materialId])
  @@index([bodyProfileId])
}

model ProductTypeComponent {
  id                String   @id @default(cuid())
  tenantId          String // Make it tenant-specific
  productType       String // Flexible product type string (e.g., "FIRE_DOOR", "CONSERVATORY", tenant custom)
  componentType     String // Flexible component type string
  displayName       String // How to label this in UI
  isRequired        Boolean  @default(false)
  defaultCode       String? // Default component code to pre-select
  sortOrder         Int      @default(0)
  formulaEnabled    Boolean  @default(false) // Can this use calculated fields?
  formulaExpression String? // JavaScript expression for calculations
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant Tenant @relation("ProductTypeComponents", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productType, componentType])
  @@index([tenantId, productType])
}

model ComponentProfile {
  id                 String   @id @default(cuid())
  componentLookupId  String   @unique // Links to ComponentLookup.id
  profileType        String // RECTANGULAR, L_SHAPE, U_CHANNEL, etc.
  dimensions         Json // {width, height, depth, etc.}
  geometry           Json? // 3D geometry data for rendering
  materialProperties Json? // Density, grain direction, etc.
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  component ComponentLookup @relation("ComponentProfile", fields: [componentLookupId], references: [id], onDelete: Cascade)

  @@index([profileType])
}

// Reusable Profile definitions for component body shapes and end joinery (tenon, shoulder, rebate, etc.)
model Profile {
  id           String   @id @default(cuid())
  tenantId     String
  code         String   // Unique profile code (e.g., "RECT-25x45", "TENON-10x30")
  name         String   // Display name (e.g., "Rectangular 25x45mm", "Tenon 10x30mm")
  profileType  String   // RECTANGULAR, L_SHAPE, U_CHANNEL, TENON, SHOULDER, REBATE, CUSTOM
  description  String?
  svgPath      String?  // SVG path data for 2D profile shape
  dimensions   Json     // {width, height, tennonLength, shoulderDepth, rebateWidth, etc.}
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant                Tenant            @relation("TenantProfiles", fields: [tenantId], references: [id], onDelete: Cascade)
  componentsBodyProfile ComponentLookup[] @relation("ComponentBodyProfile")
  componentsStartEnd    ComponentLookup[] @relation("ComponentStartEndProfile")
  componentsEndEnd      ComponentLookup[] @relation("ComponentEndEndProfile")

  @@unique([tenantId, code])
  @@index([tenantId, profileType])
}

// Dynamic attributes that can be selected for each component (e.g., timber types, finishes, grades)
model ComponentAttribute {
  id            String  @id @default(cuid())
  tenantId      String
  componentType String // LIPPING, DOOR_BLANK, etc.
  attributeName String // "Timber", "Finish", "Grade", "Profile"
  attributeType String // "SELECT", "DIMENSION", "CALCULATED", "TEXT"
  displayOrder  Int     @default(0)
  isRequired    Boolean @default(false)

  // For SELECT type attributes
  options Json? // Array of {value, label, priceModifier, metadata}

  // For CALCULATED type attributes
  calculationFormula String? // e.g., "blankHeight * 2 + blankWidth * 2" for perimeter
  calculationUnit    String? // mm, m, m2, etc.

  // Affects pricing/BOM
  affectsPrice Boolean @default(false)
  affectsBOM   Boolean @default(false)

  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant             @relation("ComponentAttributes", fields: [tenantId], references: [id], onDelete: Cascade)
  variants ComponentVariant[] @relation("VariantAttributes")

  @@unique([tenantId, componentType, attributeName])
  @@index([tenantId, componentType])
}

// Specific variant/specification of a component with actual values
model ComponentVariant {
  id                String @id @default(cuid())
  componentLookupId String // Base component this is a variant of
  tenantId          String
  variantCode       String // e.g., "LIP-OAK-10MM"
  variantName       String // e.g., "Oak Lipping 10mm"

  // Selected attribute values (JSON: {timber: "Oak", thickness: "10mm", etc.})
  attributeValues Json

  // Calculated dimensions (can reference parent door dimensions)
  dimensionFormulas Json? // {width: "blankThickness", length: "blankHeight", thickness: "10"}

  // Variant-specific pricing and sourcing
  priceModifier   Float   @default(0) // Added to base component price
  unitPrice       Float? // Override base price entirely
  supplierId      String?
  supplierSKU     String? // Supplier's part number for this specific variant
  leadTimeDays    Int?
  minimumOrderQty Float?

  // Metadata for this specific variant
  specifications Json? // Technical specs, certifications, etc.
  isActive       Boolean @default(true)
  isStocked      Boolean @default(false)
  stockLevel     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  component           ComponentLookup      @relation("ComponentVariants", fields: [componentLookupId], references: [id], onDelete: Cascade)
  tenant              Tenant               @relation("ComponentVariants", fields: [tenantId], references: [id], onDelete: Cascade)
  supplier            Supplier?            @relation("SupplierVariants", fields: [supplierId], references: [id])
  attribute           ComponentAttribute?  @relation("VariantAttributes", fields: [attributeId], references: [id])
  attributeId         String?
  bomVariantLineItems BOMVariantLineItem[] @relation("VariantBOMItems")

  @@unique([tenantId, variantCode])
  @@index([componentLookupId])
  @@index([tenantId])
  @@index([supplierId])
}

// Enhanced BOM line item that can reference specific variants
model BOMVariantLineItem {
  id                 String @id @default(cuid())
  projectId          String
  componentVariantId String // Links to specific variant with all attributes
  quantity           Float  @default(1)

  // Calculated at time of BOM generation
  calculatedDimensions Json? // Actual dimensions based on parent door
  unitPrice            Float  @default(0)
  totalPrice           Float  @default(0)
  laborCost            Float? // From process costing
  materialCost         Float? // From component variant price

  supplierId   String?
  status       BOMStatus @default(DRAFT)
  dateOrdered  DateTime?
  dateReceived DateTime?
  notes        String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  project  Project          @relation("ProjectVariantBOM", fields: [projectId], references: [id], onDelete: Cascade)
  variant  ComponentVariant @relation("VariantBOMItems", fields: [componentVariantId], references: [id])
  supplier Supplier?        @relation("SupplierVariantBOM", fields: [supplierId], references: [id])

  @@index([projectId])
  @@index([componentVariantId])
  @@index([status])
}

model Project {
  id              String  @id @default(cuid())
  tenantId        String
  projectType     String // "FIRE_DOOR_SCHEDULE", "QUOTE", "OPPORTUNITY", "CONSERVATORY_JOB", etc.
  projectName     String?
  referenceNumber String? // Job number, quote number, etc.

  // Polymorphic relations - link to actual project record
  fireDoorScheduleId String? @unique
  quoteId            String? @unique
  opportunityId      String? @unique

  status         String?
  startDate      DateTime?
  completionDate DateTime?
  metadata       Json? // Flexible storage for project-specific data
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  tenant              Tenant                   @relation("TenantProjects", fields: [tenantId], references: [id], onDelete: Cascade)
  fireDoorSchedule    FireDoorScheduleProject? @relation("ProjectFireDoorSchedule", fields: [fireDoorScheduleId], references: [id])
  quote               Quote?                   @relation("ProjectQuote", fields: [quoteId], references: [id])
  opportunity         Opportunity?             @relation("ProjectOpportunity", fields: [opportunityId], references: [id])
  bomLineItems        BOMLineItem[]            @relation("ProjectBOM")
  bomVariantLineItems BOMVariantLineItem[]     @relation("ProjectVariantBOM")

  @@index([tenantId])
  @@index([projectType])
  @@index([fireDoorScheduleId])
  @@index([quoteId])
  @@index([opportunityId])
}

model BOMLineItem {
  id                String    @id @default(cuid())
  projectId         String // Links to Project.id (works for any project type)
  componentLookupId String // Links to ComponentLookup.id
  componentType     String // Flexible component type
  quantity          Float     @default(1)
  unitPrice         Float     @default(0)
  totalPrice        Float     @default(0)
  supplierId        String? // Reference to Supplier by ID
  status            BOMStatus @default(DRAFT)
  dateOrdered       DateTime?
  dateReceived      DateTime?
  notes             String?
  metadata          Json? // Store component-specific data (dimensions, calculations, etc.)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  project   Project         @relation("ProjectBOM", fields: [projectId], references: [id], onDelete: Cascade)
  component ComponentLookup @relation("ComponentBOMItems", fields: [componentLookupId], references: [id])
  supplier  Supplier?       @relation("SupplierBOMItems", fields: [supplierId], references: [id])

  @@index([projectId])
  @@index([componentLookupId])
  @@index([status])
  @@index([supplierId])
}

// Links components to required processes with base time estimates
model ComponentProcess {
  id                  String   @id @default(cuid())
  componentLookupId   String
  processDefinitionId String // Links to existing WorkshopProcessDefinition
  sequence            Int      @default(0) // Order in which processes should be done
  baseTimeMinutes     Float    @default(0) // Initial time estimate
  timePerUnit         Float    @default(0) // Additional time per unit of measure
  setupTimeMinutes    Float    @default(0) // One-time setup time
  formulaEnabled      Boolean  @default(false)
  formulaExpression   String? // Calculate time dynamically (e.g., "perimeter * 0.5")
  isRequired          Boolean  @default(true)
  isActive            Boolean  @default(true)
  metadata            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  component         ComponentLookup           @relation("ComponentProcesses", fields: [componentLookupId], references: [id], onDelete: Cascade)
  processDefinition WorkshopProcessDefinition @relation("ProcessComponentLinks", fields: [processDefinitionId], references: [id], onDelete: Cascade)

  @@unique([componentLookupId, processDefinitionId])
  @@index([componentLookupId])
  @@index([processDefinitionId])
}

// ============================================================================
// CANONICAL PRODUCT CONFIGURATION SYSTEM
// Unified Option/Attribute engine for quote processing
// ============================================================================

// ProductType: Tree-structured product taxonomy (category -> type -> option)
model ProductType {
  id            String   @id @default(cuid())
  tenantId      String
  code          String
  name          String
  description   String?
  level         String // 'category', 'type', 'option'
  parentId      String?
  questionSetId String?
  svgPreview    String?
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant               Tenant                   @relation("TenantProductTypes", fields: [tenantId], references: [id], onDelete: Cascade)
  parent               ProductType?             @relation("ProductTypeTree", fields: [parentId], references: [id])
  children             ProductType[]            @relation("ProductTypeTree")
  questionSet          QuestionSet?             @relation("ProductTypeQuestionSet", fields: [questionSetId], references: [id])
  questionSets         QuestionSet[]            @relation("QuestionSetProductType")
  standardFieldMaps    StandardFieldMapping[]   @relation("ProductTypeStandardFieldMappings")
  componentAssignments ProductTypeComponentAssignment[] @relation("ProductTypeComponentAssignments")
  fireDoorBOMs         FireDoorBOM[]            @relation("ProductTypeFireDoorBOMs")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([parentId])
  @@index([level])
  @@index([questionSetId])
}

// Attribute: Universal attribute system replacing fragmented questionnaire fields
// ProductTypeComponentAssignment: Many-to-many relationship between ProductType and ComponentLookup
// This allows specific components to be assigned to product type options
model ProductTypeComponentAssignment {
  id              String   @id @default(cuid())
  tenantId        String
  productTypeId   String // Links to ProductType (option level)
  componentId     String // Links to ComponentLookup
  isRequired      Boolean  @default(false)
  isDefault       Boolean  @default(false) // Auto-select when product type is chosen
  sortOrder       Int      @default(0)
  quantityFormula String? // Override component's default quantity formula
  metadata        Json? // Additional config (min/max quantity, validation rules, etc.)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant      Tenant          @relation("ProductTypeComponentAssignmentsTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  productType ProductType     @relation("ProductTypeComponentAssignments", fields: [productTypeId], references: [id], onDelete: Cascade)
  component   ComponentLookup @relation("ComponentProductTypeAssignments", fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([productTypeId, componentId])
  @@index([tenantId])
  @@index([productTypeId])
  @@index([componentId])
}

model Attribute {
  id                     String   @id @default(cuid())
  tenantId               String
  code                   String
  name                   String
  description            String?
  attributeType          String // 'number', 'text', 'select', 'multiselect', 'boolean', 'date', 'json'
  unit                   String?
  options                Json?
  defaultValue           String?
  validationRules        Json?
  requiredForCosting     Boolean  @default(false)
  requiredForManufacture Boolean  @default(false)
  affectsPrice           Boolean  @default(false)
  affectsBOM             Boolean  @default(false)
  calculationFormula     String?
  hints                  Json?
  isActive               Boolean  @default(true)
  metadata               Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  tenant    Tenant     @relation("TenantAttributes", fields: [tenantId], references: [id], onDelete: Cascade)
  questions Question[] @relation("AttributeQuestions")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
}

// Question: UI presentation layer over Attributes
model Question {
  id              String   @id @default(cuid())
  tenantId        String
  attributeCode   String
  label           String
  helpText        String?
  placeholder     String?
  controlType     String // 'input', 'select', 'radio', 'checkbox', 'slider', 'date', 'textarea'
  visibilityRules Json?
  displayOrder    Int      @default(0)
  isActive        Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant           Tenant                @relation("TenantQuestions", fields: [tenantId], references: [id], onDelete: Cascade)
  attribute        Attribute             @relation("AttributeQuestions", fields: [tenantId, attributeCode], references: [tenantId, code])
  questionSetLinks QuestionSetQuestion[]

  @@index([tenantId])
  @@index([attributeCode])
  @@index([tenantId, attributeCode])
}

// QuestionSet: Groups questions for product types
model QuestionSet {
  id            String   @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  productTypeId String?
  isActive      Boolean  @default(true)
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant                @relation("TenantQuestionSets", fields: [tenantId], references: [id], onDelete: Cascade)
  productType  ProductType?          @relation("QuestionSetProductType", fields: [productTypeId], references: [id])
  productTypes ProductType[]         @relation("ProductTypeQuestionSet")
  questions    QuestionSetQuestion[]

  @@index([tenantId])
  @@index([productTypeId])
}

// QuestionSetQuestion: Join table for questions in question sets
model QuestionSetQuestion {
  id            String   @id @default(cuid())
  questionSetId String
  questionId    String
  sortOrder     Int      @default(0)
  isRequired    Boolean  @default(false)
  createdAt     DateTime @default(now())

  questionSet QuestionSet @relation(fields: [questionSetId], references: [id], onDelete: Cascade)
  question    Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionSetId, questionId])
  @@index([questionSetId])
}

// LegacyQuestionMapping: Dual-write migration bridge
model LegacyQuestionMapping {
  id                         String   @id @default(cuid())
  tenantId                   String
  legacyFieldId              String   @unique
  legacyFieldKey             String?
  attributeCode              String
  transformExpression        String?
  inverseTransformExpression String?
  isActive                   Boolean  @default(true)
  metadata                   Json?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  tenant      Tenant             @relation("TenantLegacyMappings", fields: [tenantId], references: [id], onDelete: Cascade)
  legacyField QuestionnaireField @relation("LegacyFieldMapping", fields: [legacyFieldId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([attributeCode])
}

// StandardFieldMapping: Links product-type questions/attributes to standard line-item fields
model StandardFieldMapping {
  id                  String   @id @default(cuid())
  tenantId            String
  productTypeId       String
  standardField       String // "widthMm", "heightMm", "timber", "finish", "ironmongery", "glazing", "description", "photoInsideFileId", "photoOutsideFileId"
  questionCode        String? // Link to Question.attributeCode for override source
  attributeCode       String? // Alternative: link to Attribute.code for override source
  transformExpression String? // Optional JS expression to transform value before applying
  isActive            Boolean  @default(true)
  metadata            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant      Tenant      @relation("TenantStandardFieldMappings", fields: [tenantId], references: [id], onDelete: Cascade)
  productType ProductType @relation("ProductTypeStandardFieldMappings", fields: [productTypeId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productTypeId, standardField])
  @@index([tenantId])
  @@index([productTypeId])
  @@index([standardField])
}

// ============================================================================
// END CANONICAL PRODUCT CONFIGURATION SYSTEM
// ============================================================================

// ML-powered timing predictions learned from actual time tracking
model ProcessTimingPrediction {
  id                  String  @id @default(cuid())
  tenantId            String
  processDefinitionId String // Links to existing WorkshopProcessDefinition
  componentType       String // Link to component type for pattern matching
  productType         String? // Optional product type for more specific predictions

  // Prediction data
  predictedMinutes Float
  confidenceScore  Float @default(0.5) // 0-1, higher = more confident
  sampleSize       Int   @default(0) // How many actual timings contributed

  // ML learning data
  averageActualMinutes Float?
  minActualMinutes     Float?
  maxActualMinutes     Float?
  stdDeviation         Float?
  lastLearnedAt        DateTime?

  // Context for predictions
  metadata  Json? // Store factors that affect timing (complexity, size, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant                    @relation("TenantProcessTimings", fields: [tenantId], references: [id], onDelete: Cascade)
  processDefinition WorkshopProcessDefinition @relation("ProcessTimingPredictions", fields: [processDefinitionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, processDefinitionId, componentType, productType])
  @@index([tenantId])
  @@index([processDefinitionId])
  @@index([componentType])
}

// Cost rates per process (labor cost per hour)
model ProcessCostRate {
  id                  String    @id @default(cuid())
  tenantId            String
  processDefinitionId String // Links to existing WorkshopProcessDefinition
  costPerHour         Float // Labor cost for this process
  effectiveFrom       DateTime  @default(now())
  effectiveTo         DateTime? // Null = current rate
  currency            String    @default("GBP")
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tenant            Tenant                    @relation("TenantProcessCostRates", fields: [tenantId], references: [id], onDelete: Cascade)
  processDefinition WorkshopProcessDefinition @relation("ProcessCostRates", fields: [processDefinitionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([processDefinitionId])
  @@index([effectiveFrom])
}

model FeatureRequest {
  id              String          @id @default(cuid())
  tenantId        String
  createdByUserId String
  title           String
  description     String
  category        FeatureCategory @default(OTHER)
  status          FeatureStatus   @default(OPEN)
  allowedFiles    Json?
  priority        Int?
  patchText       String?
  branchName      String?
  prUrl           String?
  checksStatus    String?
  logs            String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
}

model User {
  id                         String                      @id @default(cuid())
  tenantId                   String
  email                      String                      @unique
  workshopUsername           String?                     @unique // Username for workshop users without email
  name                       String?
  firstName                  String?
  lastName                   String?
  emailFooter                String?
  role                       String                      @default("user")
  supplierId                 String?
  isEarlyAdopter             Boolean                     @default(false)
  passwordHash               String?
  signupCompleted            Boolean                     @default(false)
  workshopHoursPerDay        Decimal?                    @default(8)
  workshopColor              String?
  profilePictureUrl          String?
  isInstaller                Boolean                     @default(false)
  isDeveloper                Boolean                     @default(false)
  isOwner                    Boolean                     @default(false)
  workshopProcessCodes       String[]
  holidayAllowance           Int?                        @default(20)
  examplePhotos              ExamplePhoto[]
  goalPlans                  GoalPlan[]
  resolvedFeedbacks          Feedback[]                  @relation("FeedbackResolver")
  feedbacks                  Feedback[]                  @relation("FeedbackAuthor")
  followUpHistories          FollowUpHistory[]
  GmailTenantConnection      GmailTenantConnection[]
  gmailUserConnection        GmailUserConnection?        @relation("GmailUserConnection")
  holidays                   Holiday[]
  Ms365TenantConnection      Ms365TenantConnection[]
  ms365UserConnection        Ms365UserConnection?        @relation("Ms365UserConnection")
  passwordResetToken         PasswordResetToken?
  PdfLayoutTemplate          PdfLayoutTemplate[]
  processPlansAssigned       ProcessPlan[]
  projectProcessAssignments  ProjectProcessAssignment[]
  approvedQuotes             Quote[]                     @relation("QuoteApprovedBy")
  signupTokens               SignupToken[]
  supplierQuoteRequests      SupplierQuoteRequest[]
  timeEntries                TimeEntry[]
  signedOffTimesheets        Timesheet[]                 @relation("TimesheetSignedOffBy")
  timesheets                 Timesheet[]                 @relation("TimesheetUser")
  workshopTimers             WorkshopTimer[]
  holidayRequests            HolidayRequest[]
  fireDoorQRScans            FireDoorQRScan[]            @relation("FireDoorQRScans")
  fireDoorMaintenanceRecords FireDoorMaintenanceRecord[] @relation("FireDoorMaintenanceRecords")
  devTimeEntries             DevTimeEntry[]
  supplier                   Supplier?                   @relation(fields: [supplierId], references: [id])
  tenant                     Tenant                      @relation(fields: [tenantId], references: [id])
  clients                    Client[]
  createdRFIs                FireDoorRFI[]               @relation("RFICreator")
  assignedRFIs               FireDoorRFI[]               @relation("RFIAssignee")
}

model SignupToken {
  id         String    @id @default(uuid())
  userId     String
  token      String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Client {
  id            String          @id @default(cuid())
  tenantId      String
  userId        String?
  name          String
  email         String?
  phone         String?
  address       String?
  city          String?
  postcode      String?
  country       String?         @default("UK")
  contactPerson String?
  companyName   String?
  type          String?         @default("public")
  source        String?
  isActive      Boolean         @default(true)
  notes         String?
  tags          String[]        @default([])
  custom        Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  leads         Lead[]
  opportunities Opportunity[]
  contacts      ClientContact[]

  @@unique([tenantId, name, email])
  @@index([tenantId])
  @@index([tenantId, name])
  @@index([tenantId, email])
  @@index([tenantId, type])
  @@index([tenantId, source])
  @@index([userId])
}

model ClientContact {
  id        String   @id @default(cuid())
  clientId  String
  name      String
  email     String?
  phone     String?
  mobile    String?
  position  String?
  isPrimary Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([email])
  @@index([clientId, isPrimary])
}

model Lead {
  id                    String                    @id @default(cuid())
  tenantId              String
  createdById           String
  clientId              String?
  contactName           String
  email                 String?
  number                String?
  phone                 String?
  address               String?
  deliveryAddress       String?
  description           String?
  status                LeadStatus                @default(NEW)
  capturedAt            DateTime                  @default(now())
  nextActionAt          DateTime?
  nextAction            String?
  briefJson             Json?
  custom                Json?
  estimatedValue        Decimal?
  quotedValue           Decimal?
  dateQuoteSent         DateTime?
  globalTimberSpec      String                    @default("")
  globalGlassSpec       String                    @default("")
  globalIronmongerySpec String                    @default("")
  globalFinishSpec      String                    @default("")
  clientAccountId       String?
  emailIngests          EmailIngest[]
  emailMessages         EmailMessage[]
  emailThreads          EmailThread[]
  followUpEvents        FollowUpEvent[]
  followUpLogs          FollowUpLog[]
  client                Client?                   @relation(fields: [clientId], references: [id])
  clientAccount         ClientAccount?            @relation(fields: [clientAccountId], references: [id])
  tenant                Tenant                    @relation(fields: [tenantId], references: [id])
  interactions          LeadInteraction[]
  visionInferences      LeadVisionInference[]
  opportunity           Opportunity?
  publicProjects        PublicProject[]
  Quote                 Quote[]
  questionnaireMatches  QuoteQuestionnaireMatch[] @relation("LeadQuestionnaireMatches")
  supplierQuoteRequests SupplierQuoteRequest[]

  @@index([clientId])
  @@index([clientAccountId])
  @@index([tenantId, clientId])
}

model LeadInteraction {
  id        String              @id @default(cuid())
  tenantId  String
  leadId    String?
  entryMode String?
  type      LeadInteractionType
  metadata  Json?
  createdAt DateTime            @default(now())
  lead      Lead?               @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([tenantId, leadId, createdAt])
  @@index([tenantId, type, createdAt])
}

model PublicProject {
  id         String                 @id @default(cuid())
  tenantId   String
  leadId     String?
  entryMode  PublicProjectEntryMode
  sourceInfo Json?
  payload    Json
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  lead       Lead?                  @relation(fields: [leadId], references: [id])

  @@index([tenantId, leadId])
  @@index([tenantId, createdAt])
}

model Opportunity {
  id                       String                     @id @default(cuid())
  tenantId                 String
  leadId                   String                     @unique
  clientId                 String?
  title                    String
  number                   String?
  description              String?
  startDate                DateTime?
  deliveryDate             DateTime?
  valueGBP                 Decimal?
  stage                    OppStage                   @default(QUALIFY)
  wonAt                    DateTime?
  lostAt                   DateTime?
  createdAt                DateTime                   @default(now())
  timberOrderedAt          DateTime?
  timberExpectedAt         DateTime?
  timberReceivedAt         DateTime?
  timberNotApplicable      Boolean                    @default(false)
  glassOrderedAt           DateTime?
  glassExpectedAt          DateTime?
  glassReceivedAt          DateTime?
  glassNotApplicable       Boolean                    @default(false)
  ironmongeryOrderedAt     DateTime?
  ironmongeryExpectedAt    DateTime?
  ironmongeryReceivedAt    DateTime?
  ironmongeryNotApplicable Boolean                    @default(false)
  paintOrderedAt           DateTime?
  paintExpectedAt          DateTime?
  paintReceivedAt          DateTime?
  paintNotApplicable       Boolean                    @default(false)
  clientAccountId          String?
  installationEndDate      DateTime?
  installationStartDate    DateTime?
  // GP calculation fields
  contractValue            Decimal?
  budgetHours              Decimal?
  materialTotal            Decimal?
  materialsToDate          Decimal?
  emailMessages            EmailMessage[]
  emailThreads             EmailThread[]
  client                   Client?                    @relation(fields: [clientId], references: [id])
  clientAccount            ClientAccount?             @relation(fields: [clientAccountId], references: [id])
  lead                     Lead                       @relation(fields: [leadId], references: [id])
  tenant                   Tenant                     @relation(fields: [tenantId], references: [id])
  processPlans             ProcessPlan[]
  projectProcesses         ProjectProcessAssignment[]
  supplierQuoteRequests    SupplierQuoteRequest[]
  timeEntries              TimeEntry[]
  workshopTimers           WorkshopTimer[]
  project                  Project?                   @relation("ProjectOpportunity")
  monthlyProjectMetrics    MonthlyProjectMetrics[]

  @@index([tenantId, stage])
  @@index([clientId])
  @@index([clientAccountId])
  @@index([tenantId, clientId])
}

model EmailIngest {
  id                String    @id @default(cuid())
  tenantId          String
  provider          String
  messageId         String
  fromEmail         String?
  subject           String?
  snippet           String?
  processedAt       DateTime?
  leadId            String?
  createdAt         DateTime  @default(now())
  aiPredictedIsLead Boolean?
  userLabelIsLead   Boolean?
  userLabeledAt     DateTime?
  lead              Lead?     @relation(fields: [leadId], references: [id])
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider, messageId], name: "tenantId_provider_messageId")
  @@index([tenantId])
}

model LeadFieldDef {
  id        String  @id @default(cuid())
  tenantId  String
  key       String
  label     String
  type      String  @default("text")
  required  Boolean @default(false)
  config    Json?
  sortOrder Int     @default(0)
  tenant    Tenant  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
  @@index([tenantId, sortOrder])
}

model GmailTenantConnection {
  id            String    @id @default(cuid())
  tenantId      String    @unique
  connectedById String?
  gmailAddress  String?
  refreshToken  String
  sentCursor    String?
  sentLastSync  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  connectedBy   User?     @relation(fields: [connectedById], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Ms365TenantConnection {
  id            String    @id @default(cuid())
  tenantId      String    @unique
  connectedById String?
  ms365Address  String?
  refreshToken  String
  sentCursor    String?
  sentLastSync  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  connectedBy   User?     @relation(fields: [connectedById], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model GmailUserConnection {
  id           String    @id @default(cuid())
  userId       String    @unique
  tenantId     String
  gmailAddress String
  refreshToken String
  sentCursor   String?
  sentLastSync DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tenant       Tenant    @relation("GmailUserConnections", fields: [tenantId], references: [id], onDelete: Cascade)
  user         User      @relation("GmailUserConnection", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, userId])
}

model Ms365UserConnection {
  id           String    @id @default(cuid())
  userId       String    @unique
  tenantId     String
  ms365Address String
  refreshToken String
  sentCursor   String?
  sentLastSync DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  tenant       Tenant    @relation("Ms365UserConnections", fields: [tenantId], references: [id], onDelete: Cascade)
  user         User      @relation("Ms365UserConnection", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, userId])
}

model LeadExample {
  id        String    @id @default(cuid())
  tenantId  String
  provider  String
  messageId String
  subject   String?
  body      String?
  extracted Json?
  label     LeadLabel @default(UNSURE)
  createdAt DateTime  @default(now())

  @@index([tenantId, provider, messageId])
}

model LeadTrainingExample {
  id        String   @id @default(cuid())
  tenantId  String
  provider  String
  messageId String
  label     String
  extracted Json?
  createdAt DateTime @default(now())

  @@index([tenantId, provider, messageId])
}

/// *
/// *  Unified TenantSettings (only ONE model)
/// * Extended with premium branding + social proof for public mobile estimator.
model TenantSettings {
  tenantId                     String    @id
  slug                         String    @unique
  brandName                    String
  introHtml                    String?
  website                      String?
  phone                        String?
  links                        Json?
  questionnaire                Json?
  logoUrl                      String?
  inbox                        Json?
  inboxLastRun                 DateTime?
  inboxWatchEnabled            Boolean   @default(false)
  quoteDefaults                Json?
  taskPlaybook                 Json?     @default("{}")
  questionnaireEmailSubject    String?
  questionnaireEmailBody       String?
  updatedAt                    DateTime  @updatedAt
  createdAt                    DateTime  @default(now())
  beta                         Json      @default("{}")
  isFireDoorManufacturer       Boolean   @default(false)
  isGroupCoachingMember        Boolean   @default(false)
  galleryImageUrls             String[]  @default([])
  heroImageUrl                 String?
  primaryColor                 String?
  reviewCount                  Int?
  reviewScore                  Decimal?
  reviewSourceLabel            String?
  secondaryColor               String?
  serviceArea                  String?
  testimonials                 Json?
  fireDoorScheduleColors       Json?
  fireDoorLineItemLayout       Json?
  fireDoorScheduleColumnConfig Json?
  productTypes                 Json?
  componentTypeLabels          Json?     @default("{}")
}

model FollowUpLog {
  id           String    @id @default(cuid())
  tenantId     String
  leadId       String
  variant      String
  subject      String
  body         String
  sentAt       DateTime  @default(now())
  opened       Boolean?
  replied      Boolean?
  converted    Boolean?
  delayDays    Int?
  messageId    String?
  provider     String?
  threadId     String?
  channel      String    @default("email")
  scheduledFor DateTime?
  metadata     Json?
  lead         Lead      @relation(fields: [leadId], references: [id])

  @@index([tenantId, leadId, sentAt])
  @@index([tenantId, channel, sentAt])
}

model FollowUpTemplate {
  id        String   @id @default(cuid())
  tenantId  String
  key       String
  subject   String
  body      String
  tone      String?
  delayDays Int
  isActive  Boolean  @default(true)
  variant   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
}

model FollowUpEvent {
  id          String    @id @default(cuid())
  tenantId    String
  leadId      String
  quoteId     String?
  variant     String
  templateKey String
  scheduledAt DateTime
  sentAt      DateTime?
  openedAt    DateTime?
  repliedAt   DateTime?
  convertedAt DateTime?
  result      String?
  source      String?
  pixelToken  String?   @unique
  costPence   Int?
  meta        Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lead        Lead      @relation(fields: [leadId], references: [id])
  quote       Quote?    @relation(fields: [quoteId], references: [id])
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@index([tenantId, leadId, scheduledAt])
}

model LeadSourceCost {
  id          String   @id @default(cuid())
  tenantId    String
  source      String
  month       DateTime
  spend       Float    @default(0)
  leads       Int      @default(0)
  conversions Int      @default(0)
  scalable    Boolean  @default(true)

  @@unique([tenantId, source, month])
  @@index([tenantId, source, month])
}

model LeadSourceSpend {
  id        String   @id @default(cuid())
  tenantId  String
  source    String
  month     DateTime
  amountGBP Decimal  @default(0)

  @@index([tenantId, source, month])
}

model SourceSpend {
  id          String   @id @default(cuid())
  tenantId    String
  source      String
  periodStart DateTime
  periodEnd   DateTime
  spendPence  Int
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId, source, periodStart, periodEnd])
}

model LeadSourceConfig {
  id       String  @id @default(cuid())
  tenantId String
  source   String
  scalable Boolean @default(true)

  @@unique([tenantId, source])
}

model FollowupExperiment {
  id            String    @id @default(cuid())
  tenantId      String
  opportunityId String
  variant       String
  source        String
  suggestedAt   DateTime
  whenISO       String
  subject       String
  body          String
  sentAt        DateTime?
  replied       Boolean?
  outcome       String?

  @@index([tenantId, opportunityId])
}

model EmailThread {
  id             String         @id @default(cuid())
  tenantId       String
  provider       String
  threadId       String
  subject        String?
  leadId         String?
  opportunityId  String?
  lastInboundAt  DateTime?
  lastOutboundAt DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  messages       EmailMessage[]
  lead           Lead?          @relation(fields: [leadId], references: [id])
  opportunity    Opportunity?   @relation(fields: [opportunityId], references: [id])
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider, threadId])
  @@index([tenantId, leadId])
  @@index([tenantId, opportunityId])
}

model EmailMessage {
  id            String       @id @default(cuid())
  tenantId      String
  threadId      String
  provider      String
  messageId     String
  fromEmail     String?
  toEmail       String?
  cc            String?
  bcc           String?
  subject       String?
  snippet       String?
  bodyText      String?
  bodyHtml      String?
  direction     String
  sentAt        DateTime
  createdAt     DateTime     @default(now())
  leadId        String?
  opportunityId String?
  lead          Lead?        @relation(fields: [leadId], references: [id])
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  thread        EmailThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider, messageId])
  @@index([tenantId, threadId, sentAt])
  @@index([tenantId, leadId])
}

/// *
/// * =============== AI Follow-up System ===============

model FollowUpRule {
  id                String   @id @default(cuid())
  tenantId          String
  trigger           String // "questionnaire_sent" | "quote_sent" | "lead_created" | "opportunity_stalled"
  delayDays         Int
  condition         String? // SQL-like condition for filtering
  taskTitle         String
  emailSubject      String
  emailBodyTemplate String?  @db.Text
  contextTemplate   String   @db.Text
  priority          String   @default("MEDIUM") // TASK priority
  autoSchedule      Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, trigger, isActive])
}

model FollowUpHistory {
  id             String    @id @default(cuid())
  taskId         String
  ruleId         String?
  tenantId       String
  userId         String
  aiDraftSubject String?
  aiDraftBody    String?   @db.Text
  finalSubject   String?
  finalBody      String?   @db.Text
  sentAt         DateTime?
  messageId      String?
  threadId       String?
  recipientEmail String
  responded      Boolean   @default(false)
  respondedAt    DateTime?
  responseTime   Int? // minutes to response
  converted      Boolean   @default(false) // led to sale/action
  userEdited     Boolean   @default(false)
  editDistance   Int? // how much user changed AI draft
  createdAt      DateTime  @default(now())
  task           Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id])

  @@index([tenantId, userId])
  @@index([taskId])
  @@index([recipientEmail])
  @@index([responded, converted])
}

model EmailConversation {
  id          String   @id @default(cuid())
  taskId      String
  tenantId    String
  messageId   String   @unique
  threadId    String?
  fromAddress String
  toAddress   String
  subject     String
  body        String   @db.Text
  htmlBody    String?  @db.Text
  direction   String // "SENT" or "RECEIVED"
  timestamp   DateTime
  inReplyTo   String?
  references  String[] @default([])
  createdAt   DateTime @default(now())
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([tenantId, threadId])
  @@index([messageId])
}

/// *
/// * =============== Quoting ===============
model Quote {
  id                    String                    @id @default(cuid())
  tenantId              String
  leadId                String?
  title                 String
  status                QuoteStatus               @default(DRAFT)
  currency              String                    @default("GBP")
  exchangeRate          Decimal?
  deliveryCost          Decimal?                  @default(0)
  markupDefault         Decimal?                  @default(0)
  subtotalMaterialGBP   Decimal?                  @default(0)
  subtotalLabourGBP     Decimal?                  @default(0)
  subtotalOtherGBP      Decimal?                  @default(0)
  totalGBP              Decimal?                  @default(0)
  proposalPdfUrl        String?
  notes                 String?
  meta                  Json?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  supplierProfileId     String?
  quoteSourceType       QuoteSourceType?
  approvalStatus        String                    @default("pending")
  approvedAt            DateTime?
  approvedById          String?
  approvedPrice         Decimal?
  clientAccountId       String?
  isTrainingExample     Boolean                   @default(false)
  mlConfidence          Decimal?
  mlEstimatedPrice      Decimal?
  mlModelVersion        String?
  priceVariancePercent  Decimal?
  trainingNotes         String?
  followUpEvents        FollowUpEvent[]
  questionnaireResponse QuestionnaireResponse?
  approvedBy            User?                     @relation("QuoteApprovedBy", fields: [approvedById], references: [id])
  clientAccount         ClientAccount?            @relation(fields: [clientAccountId], references: [id])
  lead                  Lead?                     @relation(fields: [leadId], references: [id])
  tenant                Tenant                    @relation(fields: [tenantId], references: [id])
  lines                 QuoteLine[]
  questionnaireMatches  QuoteQuestionnaireMatch[]
  shoppingLists         ShoppingList[]
  supplierFiles         UploadedFile[]
  project               Project?                  @relation("ProjectQuote")

  @@index([tenantId, leadId])
  @@index([clientAccountId])
  @@index([supplierProfileId])
  @@index([approvalStatus])
  @@index([isTrainingExample])
  @@index([tenantId, approvalStatus])
}

model QuoteLine {
  id                String             @id @default(cuid())
  quoteId           String
  supplier          String?
  sku               String?
  description       String
  qty               Decimal            @default(1)
  unitPrice         Decimal            @default(0)
  currency          String             @default("GBP")
  deliveryShareGBP  Decimal            @default(0)
  lineTotalGBP      Decimal            @default(0)
  meta              Json?
  // Standardised per-line fields to reduce day-one setup burden.
  // Expected keys (optional):
  // { widthMm?: number, heightMm?: number, timber?: string, finish?: string,
  //   ironmongery?: string, glazing?: string, description?: string,
  //   photoInsideFileId?: string, photoOutsideFileId?: string }
  lineStandard      Json?
  configuredProduct Json? // Canonical product configuration: {productTypeId, selections, derived, provenance}
  quote             Quote              @relation(fields: [quoteId], references: [id])
  shoppingListItems ShoppingListItem[]
  architectOpening  ArchitectOpening?  @relation("ArchitectOpening")

  @@index([quoteId])
}

model UploadedFile {
  id                   String                @id @default(cuid())
  tenantId             String
  quoteId              String?
  kind                 FileKind
  name                 String
  path                 String
  mimeType             String?
  sizeBytes            Int?
  uploadedAt           DateTime              @default(now())
  supplierQuoteRequest SupplierQuoteRequest?
  quote                Quote?                @relation(fields: [quoteId], references: [id])
  tenant               Tenant                @relation(fields: [tenantId], references: [id])

  @@index([tenantId, quoteId])
}

model ParsedSupplierLine {
  id          String   @id @default(cuid())
  tenantId    String
  quoteId     String
  page        Int?
  rawText     String
  description String?
  qty         Float?
  costUnit    Float?
  lineTotal   Float?
  currency    String   @default("GBP")
  supplier    String?
  confidence  Float?
  usedStages  String?
  createdAt   DateTime @default(now())
  imageIndex  Int?
  imageRef    String?

  @@index([tenantId, quoteId])
  @@index([tenantId, supplier])
}

model QuoteQuestionnaireMatch {
  id                  String   @id @default(cuid())
  tenantId            String
  quoteId             String
  leadId              String?
  questionnaireItemId String
  questionnaireLabel  String?
  description         String
  matchStatus         String   @default("unmatched")
  confidenceScore     Float    @default(0)
  parsedRowId         String?
  rowPage             Int?
  rowBBox             Json?
  imageBBox           Json?
  widthMm             Float?
  heightMm            Float?
  thicknessMm         Float?
  quantity            Float?
  unitPrice           Float?
  lineTotal           Float?
  currency            String?
  meta                Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  lead                Lead?    @relation("LeadQuestionnaireMatches", fields: [leadId], references: [id])
  quote               Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, quoteId])
  @@index([quoteId])
  @@index([leadId])
}

model LeadVisionInference {
  id          String                @id @default(cuid())
  tenantId    String
  leadId      String
  itemNumber  Int?
  source      VisionInferenceSource @default(MEASUREMENT)
  widthMm     Float?
  heightMm    Float?
  confidence  Float?
  attributes  Json?
  description String?
  notes       String?
  photoLabel  String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  lead        Lead                  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tenant      Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, leadId])
  @@index([leadId, itemNumber])
}

model SceneState {
  id          String   @id @default(cuid())
  tenantId    String
  entityType  String   // "quoteLineItem", "fireDoorsJob", etc.
  entityId    String   // ID of the entity this scene config belongs to
  config      Json     // SceneConfig object with camera, lighting, components, materials
  modifiedBy  String?  // userId who last modified
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Unique constraint: one scene config per entity
  @@unique([tenantId, entityType, entityId])
  @@index([tenantId])
  @@index([tenantId, entityType])
}

model Estimate {
  id                  String   @id @default(cuid())
  tenantId            String
  quoteId             String
  inputType           String
  inputHash           String
  currency            String   @default("GBP")
  estimatedTotal      Float
  confidence          Float
  modelVersionId      String
  promoted            Boolean  @default(false)
  actualAcceptedPrice Float?
  outcome             String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([tenantId, quoteId])
  @@index([tenantId, createdAt])
}

model InferenceEvent {
  id             String   @id @default(cuid())
  tenantId       String
  model          String
  modelVersionId String
  inputHash      String
  outputJson     Json
  confidence     Float?
  latencyMs      Int?
  createdAt      DateTime @default(now())

  @@index([tenantId, model, createdAt])
  @@index([tenantId, createdAt])
}

model ModelVersion {
  id               String    @id @default(cuid())
  model            String
  label            String
  metricsJson      Json
  datasetHash      String
  isProduction     Boolean   @default(false)
  createdAt        DateTime  @default(now())
  approvedAt       DateTime?
  approvedById     String?
  awaitingApproval Boolean   @default(false)
  versionId        String?   @unique

  @@index([model, isProduction])
}

model TrainingRun {
  id             String    @id @default(cuid())
  tenantId       String?
  model          String
  datasetHash    String
  metricsJson    Json
  status         String
  modelVersionId String?
  createdAt      DateTime  @default(now())
  datasetCount   Int?
  finishedAt     DateTime?
  startedAt      DateTime?

  @@index([model, createdAt])
  @@index([tenantId, createdAt])
}

/// *
/// * ============== ML Accuracy Tracking ==============
model MLAccuracyMetric {
  id                  String   @id @default(cuid())
  tenantId            String
  modelVersion        String
  periodStart         DateTime
  periodEnd           DateTime
  totalQuotes         Int      @default(0)
  accurateWithin10Pct Int      @default(0)
  accurateWithin20Pct Int      @default(0)
  averageVariancePct  Decimal?
  medianVariancePct   Decimal?
  confidenceAvg       Decimal?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, periodStart])
}

/// *
/// * ============== Password reset tokens ==============
model PasswordResetToken {
  userId    String   @id
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])
}

model MLTrainingSample {
  id             String         @id @default(cuid())
  tenantId       String
  messageId      String
  attachmentId   String
  url            String
  quotedAt       DateTime?
  sourceType     String         @default("supplier_quote")
  quoteId        String?
  fileId         String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  status         MLSampleStatus @default(PENDING)
  confidence     Float?
  currency       String?
  estimatedTotal Decimal?
  filename       String?
  textChars      Int?

  @@unique([tenantId, messageId, attachmentId])
  @@unique([tenantId, quoteId])
  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@index([messageId])
  @@index([attachmentId])
  @@index([quotedAt])
}

/// *
/// * ============== ML Training Visibility ==============
model TrainingInsights {
  id           String   @id @default(cuid())
  tenantId     String
  module       String
  inputSummary String?
  decision     String?
  confidence   Float?
  userFeedback Json?
  lastUpdated  DateTime @updatedAt
  createdAt    DateTime @default(now())
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, module, createdAt])
  @@index([tenantId, module, createdAt], map: "TrainingInsights_tenant_module_createdAt_idx")
}

model ModelOverride {
  id          String   @id @default(cuid())
  tenantId    String
  module      String
  key         String
  value       Json
  reason      String?
  createdById String?
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, module, key])
  @@index([tenantId, module, key], map: "ModelOverride_tenant_module_key_idx")
}

model TrainingEvent {
  id        String   @id @default(cuid())
  tenantId  String
  module    String
  kind      String
  payload   Json
  actorId   String?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, module, kind, createdAt])
  @@index([tenantId, module, kind, createdAt], map: "TrainingEvent_tenant_module_kind_createdAt_idx")
}

model Feedback {
  id                    String            @id @default(cuid())
  tenantId              String
  userId                String?
  feature               String
  rating                Int?
  comment               String?
  sourceUrl             String?
  status                FeedbackStatus    @default(OPEN)
  priority              FeedbackPriority  @default(MEDIUM)
  category              String?
  devNotes              String?
  devResponse           String?
  devScreenshotUrls     String[]          @default([])
  linkedTaskId          String?
  resolvedAt            DateTime?
  resolvedById          String?
  emailNotificationSent Boolean           @default(false)
  userResponseApproved  Boolean? // true = works for them, false = needs more dev
  userResponseAt        DateTime? // when user responded
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  resolvedBy            User?             @relation("FeedbackResolver", fields: [resolvedById], references: [id])
  tenant                Tenant            @relation(fields: [tenantId], references: [id])
  user                  User?             @relation("FeedbackAuthor", fields: [userId], references: [id])
  linkedDevTasks        DevTaskFeedback[]

  @@index([tenantId, feature, createdAt])
  @@index([tenantId, status, createdAt])
  @@index([status, priority])
}

model DevTask {
  id              String              @id @default(cuid())
  title           String
  description     String?
  status          DevTaskStatus       @default(BACKLOG)
  priority        FeedbackPriority    @default(MEDIUM)
  type            DevTaskType         @default(DEVELOPMENT)
  category        String?
  sprint          String?
  estimatedHours  Decimal?
  actualHours     Decimal?
  assignee        String? // User ID of assigned developer
  feedbackIds     String[]            @default([])
  tenantIds       String[]            @default([])
  notes           String?
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  timeEntries     DevTimeEntry[]
  assignments     DevTaskAssignment[]
  linkedFeedbacks DevTaskFeedback[]

  @@index([status, priority])
  @@index([sprint])
  @@index([type])
  @@index([assignee])
}

model DevTimeEntry {
  id         String    @id @default(cuid())
  devTaskId  String
  devTask    DevTask   @relation(fields: [devTaskId], references: [id], onDelete: Cascade)
  userId     String
  user       User      @relation(fields: [userId], references: [id])
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  durationMs Int?      @default(0)
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([devTaskId])
  @@index([userId])
  @@index([startedAt])
}

model DevDaySchedule {
  id             String   @id @default(cuid())
  date           String   @unique
  isWorkDay      Boolean  @default(true)
  availableHours Float    @default(8)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
}

model DevTaskAssignment {
  id             String   @id @default(cuid())
  devTaskId      String
  devTask        DevTask  @relation(fields: [devTaskId], references: [id], onDelete: Cascade)
  date           String
  allocatedHours Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([devTaskId])
  @@index([date])
  @@index([date, devTaskId])
}

model DevTaskFeedback {
  id         String   @id @default(cuid())
  devTaskId  String
  devTask    DevTask  @relation(fields: [devTaskId], references: [id], onDelete: Cascade)
  feedbackId String
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([devTaskId, feedbackId])
  @@index([devTaskId])
  @@index([feedbackId])
}

model Task {
  id                     String                  @id @default(cuid())
  tenantId               String
  title                  String
  description            String?
  relatedType            RelatedType
  relatedId              String?
  status                 TaskStatus              @default(OPEN)
  priority               TaskPriority            @default(MEDIUM)
  dueAt                  DateTime?
  startedAt              DateTime?
  completedAt            DateTime?
  autocreated            Boolean                 @default(true)
  meta                   Json?
  createdById            String?
  updatedById            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  autoCompleted          Boolean                 @default(false)
  checklistItems         Json?
  communicationChannel   String?
  communicationDirection CommunicationDirection?
  communicationNotes     String?
  communicationType      CommunicationType?
  completedBy            String?
  emailMessageId         String?
  followUpLogId          String?
  formSchema             Json?
  formSubmissions        Json?
  lastCompletedAt        DateTime?
  nextDueAt              DateTime?
  recurrenceInterval     Int?
  recurrencePattern      RecurrencePattern?
  requiresSignature      Boolean                 @default(false)
  signatureData          String?
  signedAt               DateTime?
  signedBy               String?
  taskType               TaskType                @default(MANUAL)
  templateId             String?
  subtasks               Subtask[]
  template               TaskTemplate?           @relation(fields: [templateId], references: [id])
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignees              TaskAssignee[]
  followUpHistory        FollowUpHistory[]
  emailConversations     EmailConversation[]

  @@index([tenantId, status, dueAt])
  @@index([tenantId, relatedType, relatedId])
  @@index([tenantId, taskType, status])
  @@index([tenantId, templateId])
  @@index([emailMessageId])
  @@index([followUpLogId])
}

model TaskAssignee {
  taskId String
  userId String
  role   AssigneeRole @default(OWNER)
  task   Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
}

model Subtask {
  id     String        @id @default(cuid())
  taskId String
  title  String
  status SubtaskStatus @default(OPEN)
  order  Int           @default(0)
  task   Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskTemplate {
  id                 String             @id @default(cuid())
  tenantId           String
  name               String
  description        String?
  isActive           Boolean            @default(true)
  taskType           TaskType
  defaultTitle       String
  defaultDescription String?
  defaultPriority    TaskPriority       @default(MEDIUM)
  relatedType        RelatedType?
  recurrencePattern  RecurrencePattern?
  recurrenceInterval Int?               @default(1)
  formSchema         Json?
  requiresSignature  Boolean            @default(false)
  checklistItems     Json?
  defaultAssigneeIds String[]
  createdById        String?
  updatedById        String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  tasks              Task[]
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
  @@index([tenantId, taskType])
}

model FormTemplate {
  id                String   @id @default(cuid())
  tenantId          String
  name              String
  description       String?
  category          String?
  formSchema        Json
  requiresSignature Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdById       String?
  updatedById       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
  @@index([tenantId, category])
}

model AutomationRule {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  enabled     Boolean  @default(true)
  trigger     Json
  conditions  Json?
  actions     Json
  createdById String?
  updatedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, enabled])
}

model Notification {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  type      NotificationType
  payload   Json
  readAt    DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, readAt])
}

model Streak {
  id               String    @id @default(cuid())
  tenantId         String
  userId           String
  dayCount         Int       @default(0)
  lastActivityDate DateTime?
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
}

model ActivityLog {
  id                    String             @id @default(cuid())
  tenantId              String
  entity                ActivityEntity
  entityId              String
  verb                  ActivityVerb
  actorId               String?
  data                  Json?
  createdAt             DateTime           @default(now())
  estimatedHeightMm     Int?
  estimatedWidthMm      Int?
  measurementConfidence Float?
  measurementSource     MeasurementSource?
  tenant                Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, entity, entityId])
  @@index([tenantId, verb])
}

model UserPreference {
  id            String @id @default(cuid())
  tenantId      String
  userId        String
  notifications Json?
  quietHours    Json?
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
}

model WorkshopProcessDefinition {
  id                  String                     @id @default(cuid())
  tenantId            String
  code                String
  name                String
  sortOrder           Int                        @default(0)
  requiredByDefault   Boolean                    @default(true)
  estimatedHours      Decimal?
  isColorKey          Boolean                    @default(false)
  assignmentGroup     String?
  isGeneric           Boolean                    @default(false)
  isLastManufacturing Boolean                    @default(false)
  isLastInstallation  Boolean                    @default(false)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  projectProcesses    ProjectProcessAssignment[]
  componentProcesses  ComponentProcess[]         @relation("ProcessComponentLinks")
  timingPredictions   ProcessTimingPrediction[]  @relation("ProcessTimingPredictions")
  costRates           ProcessCostRate[]          @relation("ProcessCostRates")
  tenant              Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, sortOrder])
}

model ProjectProcessAssignment {
  id                  String                    @id @default(cuid())
  tenantId            String
  opportunityId       String
  processDefinitionId String
  required            Boolean                   @default(true)
  assignedUserId      String?
  estimatedHours      Decimal?
  status              String                    @default("pending") // pending, in_progress, completed
  completedAt         DateTime?
  completionComments  String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  assignedUser        User?                     @relation(fields: [assignedUserId], references: [id])
  opportunity         Opportunity               @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  processDefinition   WorkshopProcessDefinition @relation(fields: [processDefinitionId], references: [id], onDelete: Cascade)
  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, processDefinitionId])
  @@index([tenantId, opportunityId])
  @@index([tenantId, assignedUserId])
}

model ProcessPlan {
  id             String          @id @default(cuid())
  tenantId       String
  projectId      String
  process        WorkshopProcess
  plannedWeek    Int
  assignedUserId String?
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  assignee       User?           @relation(fields: [assignedUserId], references: [id])
  project        Opportunity     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, projectId, process])
  @@unique([tenantId, projectId, process], map: "ProcessPlan_tenant_project_process_key")
  @@index([tenantId, assignedUserId])
  @@index([tenantId, assignedUserId], map: "ProcessPlan_tenant_assignee_idx")
}

model TimeEntry {
  id        String       @id @default(cuid())
  tenantId  String
  projectId String? // Nullable for generic processes (cleaning, admin, etc.)
  process   String // Changed from enum to String to support generic processes (CLEANING, ADMIN, etc.)
  userId    String
  date      DateTime
  hours     Decimal      @default(0)
  notes     String?
  createdAt DateTime     @default(now())
  project   Opportunity? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@index([tenantId, projectId, process])
  @@index([tenantId, date])
  @@index([tenantId, date], map: "TimeEntry_tenant_date_idx")
  @@index([tenantId, projectId, process], map: "TimeEntry_tenant_project_process_idx")
}

model Holiday {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  startDate DateTime
  endDate   DateTime
  notes     String?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
}

model WorkshopTimer {
  id               String       @id @default(cuid())
  tenantId         String
  userId           String
  projectId        String?
  process          String // Changed from enum to String to support generic processes (CLEANING, ADMIN, etc.)
  startedAt        DateTime     @default(now())
  notes            String?
  latitude         Float?
  longitude        Float?
  locationAccuracy Float?
  locationCaptured DateTime?
  outsideGeofence  Boolean      @default(false)
  tenant           Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project          Opportunity? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([userId])
  @@index([tenantId, outsideGeofence])
}

model Target {
  id                String   @id @default(cuid())
  tenantId          String
  year              Int
  enquiriesTarget   Int?     @default(0)
  quotesValueTarget Decimal? @default(0)
  quotesCountTarget Int?     @default(0)
  salesValueTarget  Decimal? @default(0)
  salesCountTarget  Int?     @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, year])
}

model LandingLead {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  source       String
  name         String
  email        String
  phone        String
  postcode     String
  projectType  String
  propertyType String
  message      String?
  userAgent    String?
  ip           String?

  @@index([email, source, createdAt])
}

model LandingTenant {
  id            String                @id @default(cuid())
  tenantId      String                @unique
  name          String?
  homeUrl       String?
  email         String?
  phone         String?
  address       String?
  brandColor    String?
  logoUrl       String?
  headline      String?
  subhead       String?
  urgencyBanner String?
  ctaText       String?               @default("Get Your Free Quote")
  guarantees    Json?
  publishedAt   DateTime?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  tenant        Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  content       LandingTenantContent?
  images        LandingTenantImage[]
  reviews       LandingTenantReview[]
}

model LandingTenantContent {
  id            String        @id @default(cuid())
  tenantId      String        @unique
  headline      String?
  subhead       String?
  priceFromText String?
  priceRange    String?
  guarantees    String?
  urgency       String?
  faqJson       String?
  leadMagnet    String?
  serviceAreas  String?
  published     Boolean       @default(false)
  updatedAt     DateTime      @updatedAt
  tenant        LandingTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model LandingTenantImage {
  id              String        @id @default(cuid())
  landingTenantId String
  url             String
  altText         String?
  caption         String?
  order           Int           @default(0)
  createdAt       DateTime      @default(now())
  tenant          LandingTenant @relation(fields: [landingTenantId], references: [id], onDelete: Cascade)

  @@index([landingTenantId, order])
}

model LandingTenantReview {
  id              String        @id @default(cuid())
  landingTenantId String
  author          String
  text            String
  rating          Int           @default(5)
  date            DateTime      @default(now())
  location        String?
  order           Int           @default(0)
  createdAt       DateTime      @default(now())
  tenant          LandingTenant @relation(fields: [landingTenantId], references: [id], onDelete: Cascade)

  @@index([landingTenantId, order])
}

model KeywordPerformance {
  id                String   @id @default(cuid())
  tenantId          String
  keyword           String
  matchType         String
  impressions       Int      @default(0)
  clicks            Int      @default(0)
  conversions       Int      @default(0)
  cost              Decimal  @default(0)
  ctr               Decimal  @default(0)
  conversionRate    Decimal  @default(0)
  cpl               Decimal  @default(0)
  qualityScore      Int?
  isActive          Boolean  @default(true)
  isUnderperforming Boolean  @default(false)
  weekStartDate     DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, keyword, weekStartDate])
  @@index([tenantId, isUnderperforming])
  @@index([weekStartDate])
}

model KeywordSuggestion {
  id             String    @id @default(cuid())
  tenantId       String
  keyword        String
  suggestedFor   String
  oldText        String?
  newText        String
  reason         String
  conversionRate Decimal
  status         String    @default("pending")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  appliedAt      DateTime?
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([createdAt])
}

/// ===============================
/// AI Autonomous Loop Sessions
/// ===============================
model AiSession {
  id          String   @id @default(cuid())
  taskKey     String
  description String
  files       Json
  mode        String
  rounds      Int      @default(0)
  maxRounds   Int      @default(3)
  status      String   @default("OPEN")
  messages    Json
  patchText   String?
  branch      String?
  prUrl       String?
  logs        String?
  usageInput  Int      @default(0)
  usageOutput Int      @default(0)
  costUsd     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])

}

/// ===============================
/// Interest Registration (Pre-launch Waitlist)
/// ===============================
model InterestRegistration {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  company   String?
  message   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

model TenantAdsConfig {
  id                  String   @id @default(cuid())
  tenantId            String   @unique
  googleAdsCustomerId String
  status              String   @default("active")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([googleAdsCustomerId])
}

model Supplier {
  id                    String                 @id @default(cuid())
  tenantId              String
  name                  String
  code                  String?
  contactPerson         String?
  email                 String?
  phone                 String?
  address               String?
  defaultCurrency       String?                @default("GBP")
  isActive              Boolean                @default(true)
  notes                 String?
  leadTimeDays          Int? // New field for component system
  preferredForTypes     String[]               @default([]) // Component types this supplier prefers
  contactInfo           Json? // Structured contact data for component system
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  materialItems         MaterialItem[]
  purchaseOrders        PurchaseOrder[]
  materials             Material[]             @relation("MaterialSupplier")
  tenant                Tenant                 @relation("SupplierToTenant", fields: [tenantId], references: [id])
  supplierQuoteRequests SupplierQuoteRequest[]
  users                 User[]
  components            ComponentLookup[]      @relation("SupplierComponents")
  bomLineItems          BOMLineItem[]          @relation("SupplierBOMItems")
  componentVariants     ComponentVariant[]     @relation("SupplierVariants")
  bomVariantLineItems   BOMVariantLineItem[]   @relation("SupplierVariantBOM")
  lookupTableRows       LookupTableRow[]       @relation("LookupRowSupplier")

  @@index([tenantId])
  @@index([email])
  @@index([tenantId, isActive])
}

model SoftwareProfile {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  displayName String
  matchHints  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation("SoftwareProfiles", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
}

model PdfLayoutTemplate {
  id                String                @id @default(cuid())
  name              String
  description       String?
  supplierProfileId String                @unique
  pageCount         Int?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  createdByUserId   String?
  meta              Json?
  annotations       PdfLayoutAnnotation[]
  createdByUser     User?                 @relation(fields: [createdByUserId], references: [id])

  @@index([name])
}

model PdfLayoutAnnotation {
  id         String             @id @default(cuid())
  templateId String
  page       Int
  x          Float
  y          Float
  width      Float
  height     Float
  label      PdfAnnotationLabel
  rowId      String?
  createdAt  DateTime           @default(now())
  template   PdfLayoutTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, page])
}

model SupplierQuoteRequest {
  id             String        @id @default(cuid())
  tenantId       String
  supplierId     String
  leadId         String?
  opportunityId  String?
  requestedById  String
  status         String        @default("pending")
  notes          String?
  sentAt         DateTime      @default(now())
  receivedAt     DateTime?
  quotedAmount   Decimal?
  uploadedFileId String?       @unique
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  lead           Lead?         @relation(fields: [leadId], references: [id])
  opportunity    Opportunity?  @relation(fields: [opportunityId], references: [id])
  requestedBy    User          @relation(fields: [requestedById], references: [id])
  supplier       Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedFile   UploadedFile? @relation(fields: [uploadedFileId], references: [id])

  @@index([tenantId])
  @@index([supplierId])
  @@index([leadId])
  @@index([opportunityId])
  @@index([status])
}

model Timesheet {
  id            String    @id @default(cuid())
  tenantId      String
  userId        String
  weekStartDate DateTime
  weekEndDate   DateTime
  totalHours    Decimal   @default(0)
  status        String    @default("pending")
  signedOffById String?
  signedOffAt   DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  signedOffBy   User?     @relation("TimesheetSignedOffBy", fields: [signedOffById], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User      @relation("TimesheetUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, weekStartDate])
  @@index([tenantId])
  @@index([userId])
  @@index([weekStartDate])
  @@index([status])
}

model Questionnaire {
  id          String                  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  isActive    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  tenant      Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fields      QuestionnaireField[]
  responses   QuestionnaireResponse[]

  @@index([tenantId, isActive])
}

model QuestionnaireField {
  id                    String                    @id @default(cuid())
  tenantId              String
  questionnaireId       String?
  key                   String
  label                 String
  type                  QuestionnaireFieldType
  options               Json?
  required              Boolean                   @default(false)
  order                 Int                       @default(0)
  sortOrder             Int                       @default(0)
  isActive              Boolean                   @default(true)
  placeholder           String?
  helpText              String?
  config                Json?
  requiredForCosting    Boolean                   @default(false)
  costingInputKey       String?
  scope                 String?                   @default("item")
  isHidden              Boolean                   @default(false)
  isStandard            Boolean                   @default(false)
  isEditable            Boolean                   @default(true)
  productTypes          String[]                  @default([])
  
  // Display flags
  showInPublicForm      Boolean                   @default(false)
  showInQuote           Boolean                   @default(true)
  isReadOnly            Boolean                   @default(false)
  
  // Line item specific
  isGlobalLineItem      Boolean                   @default(false)
  componentLookupId     String?
  replacesStandardKey   String?
  
  // Component attributes
  isComponentAttribute  Boolean                   @default(false)
  componentAttributeKey String?
  
  // Calculation & Lookup
  calculationFormula    String?
  lookupTableId         String?
  lookupInputFields     String[]                  @default([])
  lookupOutputField     String?
  
  // Data sources
  canBeSetBy            String[]                  @default([])
  autoPopulateFrom      String?
  
  // Formatting & Validation
  unit                  String?
  decimalPlaces         Int?
  min                   Float?
  max                   Float?
  
  // ML Training
  usedForMLTraining     Boolean                   @default(false)
  mlFeatureWeight       Float?                    @default(1.0)
  mlFeatureName         String?
  trackChanges          Boolean                   @default(false)
  
  // Display contexts
  defaultContexts       String[]                  @default([])
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  examplePhotoAnswers   ExamplePhotoFieldAnswer[]
  answers               QuestionnaireAnswer[]
  questionnaire         Questionnaire?            @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  componentLookup       ComponentLookup?          @relation("FieldComponentLookup", fields: [componentLookupId], references: [id], onDelete: SetNull)
  lookupTable           LookupTable?              @relation("FieldLookupTable", fields: [lookupTableId], references: [id], onDelete: SetNull)
  legacyMapping         LegacyQuestionMapping?    @relation("LegacyFieldMapping")
  displayContexts       FieldDisplayContext[]

  @@unique([tenantId, key], name: "tenantId_key")
  @@index([tenantId, questionnaireId])
  @@index([tenantId, scope])
  @@index([tenantId, showInPublicForm])
  @@index([tenantId, costingInputKey])
  @@index([isStandard, isActive])
  @@index([tenantId, isStandard])
  @@index([componentLookupId])
  @@index([lookupTableId])
}

model QuestionnaireResponse {
  id              String                @id @default(cuid())
  tenantId        String
  questionnaireId String
  quoteId         String?               @unique
  createdAt       DateTime              @default(now())
  completedAt     DateTime?
  updatedAt       DateTime              @updatedAt
  answers         QuestionnaireAnswer[]
  questionnaire   Questionnaire         @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  quote           Quote?                @relation(fields: [quoteId], references: [id])
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, questionnaireId])
  @@index([quoteId])
}

model QuestionnaireAnswer {
  id         String                @id @default(cuid())
  responseId String
  fieldId    String
  value      Json
  field      QuestionnaireField    @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  response   QuestionnaireResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  photos     QuestionnairePhoto[]

  @@unique([responseId, fieldId])
  @@index([responseId])
  @@index([fieldId])
}

model QuestionnairePhoto {
  id          String              @id @default(cuid())
  tenantId    String
  answerId    String
  filename    String
  storagePath String
  mimeType    String
  sizeBytes   Int
  caption     String?
  metadata    Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  answer      QuestionnaireAnswer @relation(fields: [answerId], references: [id], onDelete: Cascade)
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([answerId])
  @@index([createdAt])
}

model Material {
  id             String           @id @default(cuid())
  tenantId       String
  category       MaterialCategory
  code           String
  name           String
  description    String?
  supplierId     String?
  supplier       Supplier?        @relation("MaterialSupplier", fields: [supplierId], references: [id], onDelete: SetNull)
  unitCost       Decimal          @default(0)
  currency       String           @default("GBP")
  unit           String           @default("m")
  thickness      Decimal?
  width          Decimal?
  length         Decimal?
  species        String?
  grade          String?
  finish         String?
  
  // 3D Rendering fields
  color          String?          // Hex color for base material (e.g., "#8B4513" for brown timber)
  colorName      String?          // Human-readable color name (e.g., "Oak Natural", "White", "Grey")
  textureUrl     String?          // URL to texture image for realistic rendering
  textureType    String?          // WOOD_GRAIN, SOLID, METALLIC, GLASS, etc.
  roughness      Decimal?         @default(0.5) // 0 (smooth/glossy) to 1 (rough/matte)
  metalness      Decimal?         @default(0)   // 0 (non-metal) to 1 (metal)
  opacity        Decimal?         @default(1)   // 0 (transparent) to 1 (opaque)
  
  // Material properties for rendering
  renderingProps Json?            // { normalMap, bumpMap, aoMap, emissive, etc. }
  
  isActive       Boolean          @default(true)
  isStock        Boolean          @default(false)
  leadTimeDays   Int?
  minOrderQty    Decimal?
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  componentsUsingThis ComponentLookup[] @relation("ComponentMaterial")

  @@unique([tenantId, code])
  @@index([tenantId, category, isActive])
  @@index([tenantId, colorName])
}

model GlazingItem {
  id           String          @id @default(cuid())
  tenantId     String
  category     GlazingCategory
  code         String
  name         String
  description  String?
  supplier     String?
  unitCost     Decimal         @default(0)
  currency     String          @default("GBP")
  unit         String          @default("m2")
  thickness    Decimal?
  glassType    String?
  uValue       Decimal?
  fireRating   String?
  isActive     Boolean         @default(true)
  leadTimeDays Int?
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, category, isActive])
}

model DoorCore {
  id           String   @id @default(cuid())
  tenantId     String
  code         String
  name         String
  description  String?
  supplier     String?
  unitCost     Decimal  @default(0)
  currency     String   @default("GBP")
  fireRating   String?
  acoustic     Boolean  @default(false)
  maxHeight    Decimal?
  maxWidth     Decimal?
  weight       Decimal?
  isActive     Boolean  @default(true)
  leadTimeDays Int?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, fireRating, isActive])
}

model LeafStyle {
  id             String   @id @default(cuid())
  tenantId       String
  code           String
  name           String
  description    String?
  costMultiplier Decimal  @default(1.0)
  additionalCost Decimal  @default(0)
  currency       String   @default("GBP")
  panelCount     Int?
  glassArea      Decimal?
  complexity     String?
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, isActive, sortOrder])
}

model LeafFacing {
  id          String   @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  costPerM2   Decimal  @default(0)
  currency    String   @default("GBP")
  material    String?
  thickness   Decimal?
  finish      String?
  isActive    Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

model FrameFinish {
  id          String   @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  costPerM    Decimal  @default(0)
  currency    String   @default("GBP")
  material    String?
  profile     String?
  isActive    Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

model SprayFinish {
  id          String   @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  costPerM2   Decimal  @default(0)
  currency    String   @default("GBP")
  coats       Int      @default(3)
  colour      String?
  sheen       String?
  dryTimeDays Int?
  isActive    Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

model VeneerLayon {
  id          String   @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  costPerM2   Decimal  @default(0)
  currency    String   @default("GBP")
  species     String?
  grade       String?
  thickness   Decimal?
  backing     String?
  isActive    Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

model IronmongeryItem {
  id           String                @id @default(cuid())
  tenantId     String
  category     IronmongeryCategory
  code         String
  name         String
  description  String?
  supplier     String?
  unitCost     Decimal               @default(0)
  currency     String                @default("GBP")
  material     String?
  finish       String?
  fireRated    Boolean               @default(false)
  grade        String?
  isActive     Boolean               @default(true)
  leadTimeDays Int?
  notes        String?
  imageUrl     String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  tenant       Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  packItems    IronmongeryPackItem[]

  @@unique([tenantId, code])
  @@index([tenantId, category, isActive])
}

model IronmongeryPack {
  id          String                @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  doorType    String?
  fireRating  String?
  isActive    Boolean               @default(true)
  sortOrder   Int                   @default(0)
  notes       String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  tenant      Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items       IronmongeryPackItem[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive, sortOrder])
}

model IronmongeryPackItem {
  id       String          @id @default(cuid())
  packId   String
  itemId   String
  quantity Int             @default(1)
  notes    String?
  item     IronmongeryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  pack     IronmongeryPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@unique([packId, itemId])
  @@index([packId])
}

model FireCertificationRule {
  id                      String    @id @default(cuid())
  tenantId                String
  name                    String
  description             String?
  conditions              Json
  coreCode                String?
  glazingType             String?
  sealType                String?
  ironmongeryRequirements Json?
  certBody                String?
  certNumber              String?
  validUntil              DateTime?
  isActive                Boolean   @default(true)
  notes                   String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
}

model LeafSizingRule {
  id         String   @id @default(cuid())
  tenantId   String
  frameType  String
  minHeight  Decimal
  maxHeight  Decimal
  minWidth   Decimal
  maxWidth   Decimal
  fireRating String?
  maxWeight  Decimal?
  notes      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, frameType, isActive])
}

model WeightLookup {
  id            String   @id @default(cuid())
  tenantId      String
  component     String
  specification String
  weightPerM2   Decimal
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, component, specification])
  @@index([tenantId, component])
}

model ExamplePhoto {
  id             String                    @id @default(cuid())
  tenantId       String
  imageUrl       String
  thumbnailUrl   String?
  title          String
  description    String?
  tags           String[]                  @default([])
  productType    String?
  widthMm        Int?
  heightMm       Int?
  thicknessMm    Int?
  timberSpecies  String?
  timberGrade    String?
  glassType      String?
  finishType     String?
  fireRating     String?
  priceGBP       Decimal?
  priceDate      DateTime?
  supplierName   String?
  isActive       Boolean                   @default(true)
  displayOrder   Int                       @default(0)
  viewCount      Int                       @default(0)
  selectionCount Int                       @default(0)
  uploadedById   String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  tenant         Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedBy     User?                     @relation(fields: [uploadedById], references: [id])
  answers        ExamplePhotoFieldAnswer[]

  @@index([tenantId, isActive])
  @@index([tenantId, tags])
  @@index([tenantId, productType])
  @@index([displayOrder])
}

model ExamplePhotoFieldAnswer {
  id             String             @id @default(cuid())
  examplePhotoId String
  fieldId        String
  fieldKey       String
  value          String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  examplePhoto   ExamplePhoto       @relation(fields: [examplePhotoId], references: [id], onDelete: Cascade)
  field          QuestionnaireField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([examplePhotoId, fieldId])
  @@index([examplePhotoId])
  @@index([fieldKey])
}

model MaterialItem {
  id                 String               @id @default(cuid())
  tenantId           String
  supplierId         String?
  category           MaterialItemCategory
  code               String
  name               String
  description        String?
  cost               Decimal              @default(0)
  currency           String               @default("GBP")
  unit               String               @default("each")
  stockQuantity      Decimal?             @default(0)
  minStockLevel      Decimal?
  leadTimeDays       Int?
  isActive           Boolean              @default(true)
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  supplier           Supplier?            @relation(fields: [supplierId], references: [id])
  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrderLines PurchaseOrderLine[]
  shoppingListItems  ShoppingListItem[]

  @@unique([tenantId, code])
  @@index([tenantId, category, isActive])
  @@index([tenantId, supplierId])
}

model ShoppingList {
  id        String             @id @default(cuid())
  tenantId  String
  quoteId   String?
  status    ShoppingListStatus @default(DRAFT)
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  quote     Quote?             @relation(fields: [quoteId], references: [id])
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items     ShoppingListItem[]

  @@index([tenantId, status])
  @@index([quoteId])
}

model ShoppingListItem {
  id                  String       @id @default(cuid())
  shoppingListId      String
  materialItemId      String
  descriptionOverride String?
  quantity            Decimal
  unit                String
  sourceQuoteLineId   String?
  notes               String?
  createdAt           DateTime     @default(now())
  materialItem        MaterialItem @relation(fields: [materialItemId], references: [id])
  shoppingList        ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  sourceQuoteLine     QuoteLine?   @relation(fields: [sourceQuoteLineId], references: [id])

  @@index([shoppingListId])
  @@index([materialItemId])
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  tenantId     String
  supplierId   String
  status       PurchaseOrderStatus @default(DRAFT)
  orderNumber  String?
  orderDate    DateTime?
  expectedDate DateTime?
  receivedDate DateTime?
  notes        String?
  totalAmount  Decimal?            @default(0)
  currency     String              @default("GBP")
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  supplier     Supplier            @relation(fields: [supplierId], references: [id])
  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lines        PurchaseOrderLine[]

  @@index([tenantId, status])
  @@index([tenantId, supplierId])
  @@index([orderNumber])
}

model PurchaseOrderLine {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  materialItemId   String
  description      String
  quantity         Decimal
  unit             String
  unitPrice        Decimal       @default(0)
  lineTotal        Decimal       @default(0)
  receivedQuantity Decimal?      @default(0)
  notes            String?
  createdAt        DateTime      @default(now())
  materialItem     MaterialItem  @relation(fields: [materialItemId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([materialItemId])
}

model FireDoorImport {
  id          String             @id @default(cuid())
  tenantId    String
  createdById String
  sourceName  String
  status      String             @default("DRAFT")
  totalValue  Decimal            @default(0)
  currency    String             @default("GBP")
  rowCount    Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  projectId   String?
  orderId     String?
  lineItems   FireDoorLineItem[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

model FireDoorLineItem {
  id                      String           @id @default(cuid())
  fireDoorImportId        String
  tenantId                String
  rowIndex                Int
  certification           String?
  doorsetType             String?
  lajRef                  String?
  doorRef                 String?
  masterWidth             Float?
  slaveWidth              Float?
  doorHeight              Float?
  core                    String?
  rating                  String?
  coreType                String?
  top                     Float?
  btm                     Float?
  hinge                   Float?
  me                      Float?
  daExposed               Float?
  trim                    Float?
  safeHinge               Float?
  pf                      Float?
  extra                   Float?
  masterReduced           Float?
  slaveWidthReduced       Float?
  doorHeightReduced       Float?
  coreReduced             String?
  notes1                  String?
  notes2                  String?
  lajRefLipping           String?
  doorRefLipping          String?
  masterWidthLipping      Float?
  slaveWidthLipping       Float?
  doorHeightLipping       Float?
  coreLipping             String?
  ratingLipping           String?
  coreTypeLipping         String?
  material                String?
  topLipping              Float?
  btmLipping              Float?
  hingeLipping            Float?
  meLipping               Float?
  daExposedLipping        Float?
  lippingDetail           String?
  masterWidthLipping2     Float?
  slaveWidthEdging        Float?
  doorHeightEdging        Float?
  coreEdging              String?
  masterWidth2T           Float?
  slaveWidth2T            Float?
  doorHeight2T            Float?
  core2T                  String?
  doorType                String?
  note1Edge               String?
  note2Edge               String?
  lajRefFacing            String?
  doorRefFacing           String?
  masterWidthFacing       Float?
  slaveWidthFacing        Float?
  doorHeightFacing        Float?
  coreFacing              String?
  coreTypeFacing          String?
  materialFacing          String?
  topFacing               Float?
  btmFacing               Float?
  hingeFacing             Float?
  meFacing                Float?
  daExposedFacing         Float?
  calibratedSize          String?
  masterDoor              String?
  slaveDoor               String?
  bookMatching            String?
  chamferRequired         String?
  notes1Cal               String?
  note2Cal                String?
  lajRefFinish            String?
  doorRefFinish           String?
  masterWidthFinish       Float?
  slaveWidthFinish        Float?
  doorHeightFinish        Float?
  coreFinish              String?
  coreTypeFinish          String?
  doorFinish              String?
  fireRatingFinish        String?
  handingFinish           String?
  position                String?
  qtyOfHinges             Int?
  hingeType               String?
  groovesForMe            String?
  lockType                String?
  spindlePrep             String?
  cylinderPrep            String?
  lockHeight              Float?
  flushBolt               String?
  uc                      String?
  hingeInt                String?
  lockInt                 String?
  flushboltInt            String?
  vpType                  String?
  visionPanelMaster       String?
  visionPanelSlave        String?
  beadType                String?
  vpPosition              String?
  dropseal                String?
  additionalIronmongery1  String?
  additionalIronmongery2  String?
  doorRefSecondary        String?
  lockType2               String?
  spindlePrep2            String?
  cylinderPrep2           String?
  lockHeight2             Float?
  concealedDoorCloser     String?
  atgSize                 String?
  atgPosition             String?
  safehingSureclose       String?
  safehingeStandardPivot  String?
  safehingeRhinoBolts     String?
  doorViewer              String?
  letterbox               String?
  flushPulls              String?
  cableway                String?
  lajRefFinal             String?
  doorRefFinal            String?
  master                  Float?
  slave                   Float?
  height                  Float?
  coreFinal               String?
  fireRatingFinal         String?
  doorFinishFinal         String?
  fireSealsInMe           String?
  glazingSystem           String?
  vpSize                  String?
  glassType               String?
  cassetteType            String?
  dropSeal                String?
  hinges                  String?
  handingFinal            String?
  lock                    String?
  lockHeightOnDoor        Float?
  keep                    String?
  flushBolts              String?
  fittedInFrame           String?
  hingeLockFlushboltIntum String?
  qMarkPlug               String?
  itemType                String?
  code                    String?
  quantity                Int?
  location                String?
  acousticRatingDb        Int?
  internalColour          String?
  externalColour          String?
  frameFinish             String?
  leafHeight              Float?
  masterLeafWidth         Float?
  slaveLeafWidth          Float?
  leafThickness           Float?
  leafConfiguration       String?
  ifSplitMasterSize       String?
  doorFinishSide1         String?
  doorFinishSide2         String?
  doorFacing              String?
  lippingFinish           String?
  doorEdgeProtType        String?
  doorEdgeProtPos         String?
  doorUndercut            String?
  doorUndercutMm          Float?
  visionQtyLeaf1          Int?
  vp1WidthLeaf1           Float?
  vp1HeightLeaf1          Float?
  vp2WidthLeaf1           Float?
  vp2HeightLeaf1          Float?
  visionQtyLeaf2          Int?
  vp1WidthLeaf2           Float?
  vp1HeightLeaf2          Float?
  vp2WidthLeaf2           Float?
  vp2HeightLeaf2          Float?
  totalGlazedAreaMaster   Float?
  fanlightSidelightGlz    String?
  glazingTape             String?
  ironmongeryPackRef      String?
  closerOrFloorSpring     String?
  spindleFacePrep         String?
  cylinderFacePrep        String?
  flushBoltSupplyPrep     String?
  flushBoltQty            Int?
  fingerProtection        String?
  fireSignage             String?
  fireSignageQty          Int?
  fireSignageFactoryFit   String?
  fireIdDisc              String?
  fireIdDiscQty           Int?
  doorViewerPosition      String?
  doorViewerPrepSize      String?
  doorChain               String?
  doorViewersQty          Int?
  doorChainFactoryFit     String?
  doorViewersFactoryFit   String?
  additionNote1           String?
  additionNote1Qty        Int?
  unitValue               Decimal?
  labourCost              Decimal?
  materialCost            Decimal?
  lineTotal               Decimal?
  rawRowJson              Json
  initialCncProgramUrl    String?
  finalCncTrimProgramUrl  String?
  // Calculated fields for manufacturing
  cncBlankWidth           Float?
  cncBlankHeight          Float?
  cncTrimWidth            Float?
  cncTrimHeight           Float?
  totalLinearMeters       Float?
  totalSquareMeters       Float?
  lippingLinearMeters     Float?
  facingSquareMeters      Float?
  fullReference           String?
  calculatedField1        String?
  calculatedField2        String?
  calculatedField3        String?
  calculatedField4        String?
  calculatedField5        String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  import                  FireDoorImport         @relation(fields: [fireDoorImportId], references: [id], onDelete: Cascade)
  qrScans                 FireDoorQRScan[]
  components              ComponentInstance[]

  @@index([tenantId, fireDoorImportId])
  @@index([tenantId, rating])
  @@index([fireDoorImportId, rowIndex])
}

// Component system for BOM generation from line items
model ComponentDefinition {
  id                    String              @id @default(cuid())
  tenantId              String
  name                  String              // "Door Blank", "Frame Jamb", "Hinge"
  category              String              // "MANUFACTURED", "PURCHASED", "ASSEMBLY"
  description           String?
  propertyMappings      Json                // How to extract properties from line item
  creationRules         Json                // When to create this component
  preview3DTemplate     Json?               // Template for 3D preview
  cncProgramTemplate    String?             // CNC program template
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  instances             ComponentInstance[]
  
  @@index([tenantId, category])
  @@index([tenantId, isActive])
}

model ComponentInstance {
  id                    String              @id @default(cuid())
  tenantId              String
  fireDoorLineItemId    String
  definitionId          String
  properties            Json                // Extracted property values
  quantity              Int                 @default(1)
  unitCost              Decimal?            @db.Decimal(10, 2)
  totalCost             Decimal?            @db.Decimal(10, 2)
  status                String              @default("PENDING") // PENDING, ORDERED, IN_PRODUCTION, COMPLETE
  supplier              String?
  orderReference        String?
  position3D            Json?               // {x, y, z, rotation} for 3D preview
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lineItem              FireDoorLineItem    @relation(fields: [fireDoorLineItemId], references: [id], onDelete: Cascade)
  definition            ComponentDefinition @relation(fields: [definitionId], references: [id])
  
  @@index([tenantId, fireDoorLineItemId])
  @@index([definitionId])
  @@index([status])
}

model FireDoorScheduleProject {
  id                       String                  @id @default(cuid())
  tenantId                 String
  projectId                String?
  mjsNumber                String?
  jobName                  String?
  clientName               String?
  dateReceived             DateTime?
  dateRequired             DateTime?
  poNumber                 String?
  laqNumber                String?
  compOrderNumber          String?
  jobLocation              String?
  signOffStatus            String?
  signOffDate              DateTime?
  scheduledBy              String?
  leadTimeWeeks            Int?
  calculatedCompletionDate DateTime?
  approxDeliveryDate       DateTime?
  workingDaysRemaining     Int?
  blanksStatus             String?
  blanksChecked            Boolean                 @default(false)
  lippingsStatus           String?
  lippingsChecked          Boolean                 @default(false)
  facingsStatus            String?
  facingsChecked           Boolean                 @default(false)
  glassStatus              String?
  glassChecked             Boolean                 @default(false)
  cassettesStatus          String?
  cassettesChecked         Boolean                 @default(false)
  timbersStatus            String?
  timbersChecked           Boolean                 @default(false)
  ironmongeryStatus        String?
  ironmongeryChecked       Boolean                 @default(false)
  blanksCutPercent         Int?
  edgebandPercent          Int?
  calibratePercent         Int?
  facingsPercent           Int?
  finalCncPercent          Int?
  finishPercent            Int?
  sandPercent              Int?
  sprayPercent             Int?
  cutPercent               Int?
  cncPercent               Int?
  buildPercent             Int?
  overallProgress          Int?
  hiddenStatus             String?
  doorPaperworkStatus      String?
  finalCncSheetStatus      String?
  finalChecksSheetStatus   String?
  deliveryChecklistStatus  String?
  framesPaperworkStatus    String?
  paperworkComments        String?
  bomNotes                 String?
  certificationRequired    String?
  fscRequired              Boolean                 @default(false)
  invoiceStatus            String?
  transportStatus          String?
  deliveryDate             DateTime?
  installStart             DateTime?
  installEnd               DateTime?
  snaggingStatus           String?
  snaggingComplete         Boolean                 @default(false)
  snaggingNotes            String?
  communicationNotes       String?
  internalNotes            String?
  lastUpdatedBy            String?
  lastUpdatedAt            DateTime                @default(now())
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  blanksDateExpected       DateTime?
  blanksDateOrdered        DateTime?
  blanksDateReceived       DateTime?
  bomPercent               Int?
  cassettesDateExpected    DateTime?
  cassettesDateOrdered     DateTime?
  cassettesDateReceived    DateTime?
  deliveryNotes            String?
  doorSets                 Int?
  facingsDateExpected      DateTime?
  facingsDateOrdered       DateTime?
  facingsDateReceived      DateTime?
  glassDateExpected        DateTime?
  glassDateOrdered         DateTime?
  glassDateReceived        DateTime?
  ironmongeryDateExpected  DateTime?
  ironmongeryDateOrdered   DateTime?
  ironmongeryDateReceived  DateTime?
  leaves                   Int?
  lippingsDateExpected     DateTime?
  lippingsDateOrdered      DateTime?
  lippingsDateReceived     DateTime?
  netValue                 Decimal?
  paperworkPercent         Int?
  productionPercent        Int?
  timbersDateExpected      DateTime?
  timbersDateOrdered       DateTime?
  timbersDateReceived      DateTime?
  clientOrderNo            String?
  typeOfJob                String?
  lajClientComments        String?
  clientComments           String?
  factoryFitIronmongeryReleased String?
  qrCodes                  Boolean                 @default(false)
  productionLogs           FireDoorProductionLog[]
  project                  Project?                @relation("ProjectFireDoorSchedule")
  tenant                   Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rfis                     FireDoorRFI[]           @relation("FireDoorRFIs")

  @@index([tenantId])
  @@index([tenantId, jobLocation])
  @@index([tenantId, signOffStatus])
  @@index([tenantId, dateRequired])
  @@index([projectId])
}

model FireDoorProductionLog {
  id              String                  @id @default(cuid())
  tenantId        String
  projectId       String
  process         String
  previousPercent Int
  addedPercent    Int
  newPercent      Int
  loggedBy        String
  loggedAt        DateTime                @default(now())
  notes           String?
  project         FireDoorScheduleProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant          Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, projectId])
  @@index([tenantId, loggedAt])
  @@index([projectId, process])
}

model ClientAccount {
  id             String              @id @default(cuid())
  tenantId       String
  companyName    String
  accountNumber  String?
  primaryContact String?
  email          String
  phone          String?
  address        String?
  city           String?
  postcode       String?
  country        String?             @default("UK")
  isActive       Boolean             @default(true)
  notes          String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users          ClientUser[]
  jobs           FireDoorClientJob[]
  leads          Lead[]
  opportunities  Opportunity[]
  quotes         Quote[]

  @@index([tenantId])
  @@index([tenantId, email])
  @@index([tenantId, companyName])
}

model ClientUser {
  id               String        @id @default(cuid())
  clientAccountId  String
  email            String        @unique
  passwordHash     String
  firstName        String
  lastName         String
  phone            String?
  jobTitle         String?
  isActive         Boolean       @default(true)
  emailVerified    Boolean       @default(false)
  lastLoginAt      DateTime?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  clientAccount    ClientAccount @relation(fields: [clientAccountId], references: [id], onDelete: Cascade)

  @@index([clientAccountId])
  @@index([email])
}

model FireDoorClientJob {
  id                  String                   @id @default(cuid())
  tenantId            String
  clientAccountId     String
  submittedBy         String?
  jobName             String
  projectReference    String?
  siteAddress         String?
  deliveryAddress     String?
  contactPerson       String?
  contactEmail        String?
  contactPhone        String?
  poNumber            String?
  quoteReference      String?
  dateRequired        DateTime?
  status              String                   @default("PENDING_REVIEW")
  totalPrice          Decimal?
  pricePerUnit        Json?
  pricedAt            DateTime?
  pricedBy            String?
  productionStarted   DateTime?
  estimatedCompletion DateTime?
  actualCompletion    DateTime?
  clientNotes         String?
  internalNotes       String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  submittedAt         DateTime                 @default(now())
  doorItems           FireDoorClientDoorItem[]
  clientAccount       ClientAccount            @relation(fields: [clientAccountId], references: [id], onDelete: Cascade)
  tenant              Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rfis                FireDoorClientRFI[]
  qrScans             FireDoorQRScan[]

  @@index([tenantId])
  @@index([clientAccountId])
  @@index([tenantId, status])
  @@index([tenantId, dateRequired])
  @@index([submittedAt])
}

model FireDoorClientDoorItem {
  id                           String                      @id @default(cuid())
  tenantId                     String
  fireDoorClientJobId          String
  rowNumber                    Int?
  sequence                     String?
  doorRef                      String?
  location                     String?
  quantity                     Int?
  type                         String?
  coreType                     String?
  fireRating                   String?
  acousticRating               String?
  thresholdSealType            String?
  doorsetLeafFrame             String?
  configuration                String?
  masterLeafWidth              Decimal?
  soH                          String?
  soW                          String?
  ofH                          String?
  ofW                          String?
  sOWallThickness              Decimal?
  frameMaterial                String?
  frameFinish                  String?
  frameType                    String?
  antiBarricadeEmergencyStops  String?
  architraveMaterialFinish     String?
  arcWidth                     Decimal?
  arcDepth                     Decimal?
  doorFacing                   String?
  doorFinish                   String?
  doorColour                   String?
  lippingMaterial              String?
  doorAction                   String?
  doorUndercut                 String?
  aperture                     String?
  apertureWidth                Decimal?
  apertureHeight               Decimal?
  vistamaticSupplyType         String?
  vistmaticHardwareSide1       String?
  vistamaticHardwareSide2      String?
  beadType                     String?
  beadMaterial                 String?
  lwGlassType                  String?
  hingeSupplyType              String?
  hingeFitting                 String?
  hingeType                    String?
  hingeConfiguration           String?
  handing                      String?
  lockSupplyPrep               Boolean?
  lockFitting                  String?
  lockType1                    String?
  lockHeightToSpindle1         Decimal?
  spindlePrep                  Boolean?
  cylinderPrep                 Boolean?
  lockType2                    String?
  lockHeightToSpindle2         Decimal?
  closersFloorSprings          String?
  flushBoltSupplyPrep          Boolean?
  specials                     String?
  leadLiningCode               String?
  overpanelDetails             String?
  screenDetails                String?
  airTransferGrilleRequirement String?
  airTransferGrilleSize        Decimal?
  airTransferGrillePosition    String?
  doorEdgeProtectionType       Boolean?
  doorEdgeProtectionPosition   Boolean?
  kickPlates                   String?
  pvcFaceProtection            Boolean?
  wiringPrep                   Boolean?
  freeIssueCableLoopPrep       Boolean?
  fireIdDisc                   String?
  ironmongeryPackRef           String?
  comments                     String?
  unitPrice                    Decimal?
  lineTotal                    Decimal?
  rawRowJson                   Json?
  installationDate             DateTime?
  lastMaintenanceDate          DateTime?
  nextMaintenanceDate          DateTime?
  maintenanceNotes             String?
  fittingInstructions          String?
  installerNotes               String?
  createdAt                    DateTime                    @default(now())
  updatedAt                    DateTime                    @updatedAt
  job                          FireDoorClientJob           @relation(fields: [fireDoorClientJobId], references: [id], onDelete: Cascade)
  qrScans                      FireDoorQRScan[]
  maintenanceRecords           FireDoorMaintenanceRecord[]

  @@index([fireDoorClientJobId])
  @@index([tenantId])
  @@index([doorRef])
}

model FireDoorClientRFI {
  id                  String            @id @default(cuid())
  tenantId            String
  fireDoorClientJobId String
  subject             String
  question            String
  doorItemRef         String?
  response            String?
  respondedBy         String?
  respondedAt         DateTime?
  status              String            @default("OPEN")
  priority            String            @default("NORMAL")
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  job                 FireDoorClientJob @relation(fields: [fireDoorClientJobId], references: [id], onDelete: Cascade)

  @@index([fireDoorClientJobId])
  @@index([tenantId])
  @@index([status])
}

model FireDoorProcessQRConfig {
  id            String   @id @default(cuid())
  tenantId      String
  processName   String
  displayFields Json     @default("[]")
  instructions  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation("FireDoorProcessQRConfigs", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, processName])
  @@index([tenantId])
}

model FireDoorQRScan {
  id          String                  @id @default(cuid())
  tenantId    String
  lineItemId  String?
  clientJobId String?
  doorItemId  String?
  scanType    String
  processName String?
  scannedBy   String?
  scannedAt   DateTime                @default(now())
  deviceInfo  String?
  notes       String?
  tenant      Tenant                  @relation("FireDoorQRScans", fields: [tenantId], references: [id], onDelete: Cascade)
  lineItem    FireDoorLineItem?       @relation(fields: [lineItemId], references: [id], onDelete: SetNull)
  clientJob   FireDoorClientJob?      @relation(fields: [clientJobId], references: [id], onDelete: SetNull)
  doorItem    FireDoorClientDoorItem? @relation(fields: [doorItemId], references: [id], onDelete: SetNull)
  user        User?                   @relation("FireDoorQRScans", fields: [scannedBy], references: [id], onDelete: SetNull)

  @@index([lineItemId])
  @@index([clientJobId])
  @@index([doorItemId])
  @@index([scanType])
  @@index([tenantId])
}

model FireDoorMaintenanceRecord {
  id              String                 @id @default(cuid())
  tenantId        String
  doorItemId      String
  performedBy     String?
  performedByName String?
  performedAt     DateTime               @default(now())
  maintenanceType String
  status          String
  findings        String?
  actionsTaken    String?
  photos          Json                   @default("[]")
  nextDueDate     DateTime?
  createdAt       DateTime               @default(now())
  tenant          Tenant                 @relation("FireDoorMaintenanceRecords", fields: [tenantId], references: [id], onDelete: Cascade)
  doorItem        FireDoorClientDoorItem @relation(fields: [doorItemId], references: [id], onDelete: Cascade)
  user            User?                  @relation("FireDoorMaintenanceRecords", fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([doorItemId])
  @@index([performedAt])
  @@index([tenantId])
}

model Rfi {
  id              String   @id @default(cuid())
  tenantId        String
  projectId       String
  rowId           String?
  columnKey       String
  title           String?
  message         String
  status          String   @default("open")
  visibleToClient Boolean  @default(true)
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, projectId])
  @@index([tenantId, projectId, columnKey])
  @@index([tenantId, status])
}

enum FeatureStatus {
  OPEN
  IN_PROGRESS
  READY_FOR_REVIEW
  APPROVED
  REJECTED
  APPLIED
  FAILED
}

enum FeatureCategory {
  UI
  COPY
  PRICING
  ANALYTICS
  INTEGRATION
  OTHER
}

enum LeadInteractionType {
  QUESTIONNAIRE_STARTED
  QUESTIONNAIRE_COMPLETED
  ESTIMATE_PREVIEWED
  ESTIMATE_SHARED
  ESTIMATE_FAVOURITED
  PROJECT_SAVED
  CLIENT_PROCEEDED
  CLIENT_DECLINED
  STEP_VIEWED
  STEP_COMPLETED
  ITEM_ADDED
  ITEM_UPDATED
  ITEM_REMOVED
  ITEM_EDITED
  SPECS_UPDATED
}

enum VisionInferenceSource {
  MEASUREMENT
  INSPIRATION
}

enum PublicProjectEntryMode {
  AD
  INVITE
}

enum MLSampleStatus {
  PENDING
  APPROVED
  REJECTED
}

/// *
/// * =========================
/// * Enums
/// * =========================
enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  incomplete
  incomplete_expired
  paused
}

enum Plan {
  monthly
  annual
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  INFO_REQUESTED
  REJECTED
  READY_TO_QUOTE
  ESTIMATE
  QUOTE_SENT
  WON
  LOST
}

enum OppStage {
  QUALIFY
  PROPOSE
  NEGOTIATE
  WON
  LOST
  COMPLETED
}

enum LeadLabel {
  LEAD
  NOT_LEAD
  UNSURE
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum FileKind {
  SUPPLIER_QUOTE
  CLIENT_QUOTE
  LINE_IMAGE
  OTHER
}

enum FeedbackStatus {
  OPEN
  IN_REVIEW
  PLANNED
  IN_PROGRESS
  COMPLETED
  WONT_FIX
  DUPLICATE
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DevTaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  TESTING
  DONE
  BLOCKED
}

enum DevTaskType {
  DEVELOPMENT
  BUG_FIX
  FEATURE
  COACHING
  FAMILY_TIME
  HOUSEWORK
  ADMIN
  LEARNING
  MEETING
  OTHER
}

enum RelatedType {
  LEAD
  PROJECT
  QUOTE
  EMAIL
  QUESTIONNAIRE
  WORKSHOP
  OPPORTUNITY
  OTHER
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  MANUAL
  COMMUNICATION
  FOLLOW_UP
  SCHEDULED
  FORM
  CHECKLIST
}

enum CommunicationType {
  EMAIL
  PHONE
  MEETING
  SMS
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum RecurrencePattern {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum MeasurementSource {
  MANUAL
  PHOTO_ESTIMATE
}

enum AssigneeRole {
  OWNER
  FOLLOWER
}

enum SubtaskStatus {
  OPEN
  DONE
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE_SOON
  TASK_OVERDUE
  MENTION
  STREAK
  SUMMARY
  LEAD_SUGGESTION
  QUOTE_FOLLOWUP_SCHEDULED
  QUESTIONNAIRE_FOLLOWUP_SCHEDULED
  FOLLOW_UP_REPLY
}

enum ActivityEntity {
  TASK
  RULE
  PROJECT
}

enum ActivityVerb {
  CREATED
  ASSIGNED
  STARTED
  COMPLETED
  REOPENED
  OVERDUE
  NUDGED
}

enum WorkshopProcess {
  MACHINING
  ASSEMBLY
  SANDING
  SPRAYING
  FINAL_ASSEMBLY
  GLAZING
  IRONMONGERY
  INSTALLATION
}

enum QuestionnaireFieldType {
  TEXT
  NUMBER
  SELECT
  BOOLEAN
  TEXTAREA
  DATE
}

enum QuoteSourceType {
  SUPPLIER
  USER_SOFTWARE
}

enum PdfAnnotationLabel {
  JOINERY_IMAGE
  DESCRIPTION
  QTY
  UNIT_COST
  LINE_TOTAL
  DELIVERY_ROW
  HEADER_LOGO
  IGNORE
}

enum MaterialCategory {
  TIMBER_HARDWOOD
  TIMBER_SOFTWOOD
  BOARD_MDF
  BOARD_PLYWOOD
  MOULDING_BEAD
  MOULDING_GROOVE
  RAISED_PANEL
  VENEER_SHEET
}

enum GlazingCategory {
  GLASS
  BEADING
  GLAZING_TAPE
  INTUMESCENT_STRIP
}

enum IronmongeryCategory {
  HINGE
  PIVOT
  DOOR_CLOSER
  LOCK
  LATCH
  LEVER_HANDLE
  PULL_HANDLE
  ESCUTCHEON
  TURN
  CYLINDER
  DOOR_VIEWER
  KICK_PLATE
  FINGER_PLATE
  BUMP_PLATE
  FIRE_PIN
  FIRE_SIGNAGE
  DOOR_EDGE_GUARD
  DOOR_CHAIN
  CABLEWAY
  FINGER_PROTECTION
  AIR_TRANSFER_GRILLE
  INTUMESCENT_SEAL
  LEAD_LINING
  OTHER
}

enum MaterialItemCategory {
  DOOR_BLANK
  LIPPING
  IRONMONGERY
  GLASS
  TIMBER
  BOARD
  VENEER
  FINISH
  HARDWARE
  CONSUMABLE
  OTHER
}

enum ShoppingListStatus {
  DRAFT
  APPROVED
  ORDERED
  RECEIVED
  CANCELLED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

/// Field  Task linking for generic entities
model TaskFieldLink {
  id                  String   @id @default(cuid())
  tenantId            String
  model               String // Prisma model name e.g., "Opportunity", "Lead", "FireDoorScheduleProject"
  fieldPath           String // Dot path within model json fields or top-level field name
  label               String?
  completionCondition Json? // e.g., { kind: "NON_NULL" } | { kind: "EQUALS", value: "Printed in Office" } | { kind: "DATE_SET" }
  onTaskComplete      Json? // e.g., { kind: "SET_NOW" } | { kind: "SET_VALUE", value: "Printed in Office" } | { kind: "SET_TRUE" }
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, model, fieldPath])
}

/// Marketing analytics for public estimator funnel
model AnalyticsEvent {
  id        String   @id @default(cuid())
  tenantId  String
  type      String // ad_impression | landing | estimator_start | estimator_step | estimator_complete
  source    String? // facebook | instagram | other
  utm       Json?
  stepIndex Int?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type, timestamp])
}

// ========================================
// COACHING HUB MODELS
// ========================================

model GoalPlan {
  id          String   @id @default(cuid())
  tenantId    String
  ownerUserId String
  title       String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner  User           @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  months MonthlyGoal[]
  notes  CoachingNote[]

  @@index([tenantId, ownerUserId])
}

model MonthlyGoal {
  id          String  @id @default(cuid())
  goalPlanId  String
  monthNumber Int
  title       String
  description String
  aiSuggested Boolean @default(true)
  progress    Float   @default(0)

  plan  GoalPlan     @relation(fields: [goalPlanId], references: [id], onDelete: Cascade)
  weeks WeeklyGoal[]

  @@index([goalPlanId, monthNumber])
}

model WeeklyGoal {
  id            String  @id @default(cuid())
  monthlyGoalId String
  weekNumber    Int
  title         String
  description   String
  aiSuggested   Boolean @default(true)
  progress      Float   @default(0)

  month MonthlyGoal @relation(fields: [monthlyGoalId], references: [id], onDelete: Cascade)
  tasks GoalTask[]

  @@index([monthlyGoalId, weekNumber])
}

model GoalTask {
  id           String         @id @default(cuid())
  weeklyGoalId String
  title        String
  description  String?
  dueDate      DateTime?
  status       GoalTaskStatus @default(TODO)
  aiSuggested  Boolean        @default(true)

  week WeeklyGoal @relation(fields: [weeklyGoalId], references: [id], onDelete: Cascade)

  @@index([weeklyGoalId, status])
}

enum GoalTaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

model CoachingNote {
  id             String   @id @default(cuid())
  goalPlanId     String
  sessionDate    DateTime
  notes          String
  commitments    String[]
  autoAddToTasks Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  plan GoalPlan @relation(fields: [goalPlanId], references: [id], onDelete: Cascade)

  @@index([goalPlanId, sessionDate])
}

model FinancialPlan {
  id            String   @id @default(cuid())
  tenantId      String
  startYear     Int
  durationYears Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant  Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  years   FinancialYear[]
  targets FinancialTarget[]

  @@index([tenantId, startYear])
}

model FinancialYear {
  id              String   @id @default(cuid())
  financialPlanId String
  year            Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  plan   FinancialPlan @relation(fields: [financialPlanId], references: [id], onDelete: Cascade)
  months MonthlyPnl[]

  @@index([financialPlanId, year])
}

model MonthlyPnl {
  id              String   @id @default(cuid())
  financialYearId String
  monthNumber     Int
  revenue         Float    @default(0)
  directLabour    Float    @default(0)
  materials       Float    @default(0)
  marketing       Float    @default(0)
  overheads       Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  year FinancialYear @relation(fields: [financialYearId], references: [id], onDelete: Cascade)

  @@index([financialYearId, monthNumber])
}

model FinancialTarget {
  id                 String                 @id @default(cuid())
  financialPlanId    String
  horizon            FinancialTargetHorizon
  year               Int?
  revenueTarget      Float?
  grossProfitTarget  Float?
  netProfitTarget    Float?
  grossMarginTarget  Float?
  netMarginTarget    Float?
  labourPctTarget    Float?
  materialsPctTarget Float?
  marketingPctTarget Float?
  overheadsPctTarget Float?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  plan FinancialPlan @relation(fields: [financialPlanId], references: [id], onDelete: Cascade)

  @@index([financialPlanId, horizon])
}

enum FinancialTargetHorizon {
  YEAR
  FIVE_YEAR
}

model WealdenImage {
  id        String   @id @default(cuid())
  slotId    String   @unique
  imageUrl  String
  filename  String
  width     Int?
  height    Int?
  mimeType  String?
  fileSize  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slotId])
}

// Lookup tables for dynamic dropdowns and pricing
model LookupTable {
  id          String            @id @default(cuid())
  tenantId    String
  tableName   String            // e.g., "Timber", "Glass", "Hinges", "Lock Types"
  category    String?           // "material", "ironmongery", "finish", "certification"
  description String?
  isStandard  Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  tenant      Tenant            @relation("LookupTables", fields: [tenantId], references: [id], onDelete: Cascade)
  rows        LookupTableRow[]
  fields      QuestionnaireField[] @relation("FieldLookupTable")
  componentTemplates ComponentTemplate[] @relation("TemplateLookupTable")
  
  @@unique([tenantId, tableName])
  @@index([tenantId])
  @@index([tenantId, category])
}

// Unified lookup table row - replaces MaterialItems, IronmongeryItems, pricing tables
model LookupTableRow {
  id              String        @id @default(cuid())
  lookupTableId   String
  
  // Display fields
  value           String        // Unique identifier within table (e.g., "oak-european")
  label           String        // Display name (e.g., "European Oak")
  description     String?
  code            String?       // Supplier/internal code
  sortOrder       Int           @default(0)
  isActive        Boolean       @default(true)
  
  // Pricing fields
  costPerUnit     Decimal?      @default(0)
  unitType        String?       // "sqm", "meter", "each", "kg", "pair"
  currency        String        @default("GBP")
  markup          Decimal?      // Percentage markup for pricing
  
  // Supplier/BOM fields
  supplierId      String?
  supplierCode    String?
  leadTimeDays    Int?
  weight          Decimal?      // kg per unit
  weightUnit      String?       // "kg", "g"
  
  // 3D/Visual fields
  texture         String?       // URL or material code for 3D rendering
  colorHex        String?       // Color for visualization
  materialType    String?       // "wood", "metal", "glass", "composite"
  materialProps   Json?         // Material properties for 3D (roughness, metallic, etc.)
  imageUrl        String?
  
  // Technical specifications
  fireRated       Boolean       @default(false)
  fireRating      String?       // "FD30", "FD60", etc.
  grade           String?       // Quality/performance grade
  finish          String?       // Surface finish type
  dimensions      Json?         // Standard dimensions if applicable
  
  // Extended metadata (extensible for product-specific properties)
  customProps     Json?         // Any additional properties specific to this item type
  
  // Audit
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  lookupTable     LookupTable   @relation(fields: [lookupTableId], references: [id], onDelete: Cascade)
  supplier        Supplier?     @relation("LookupRowSupplier", fields: [supplierId], references: [id])
  
  @@unique([lookupTableId, value])
  @@index([lookupTableId, isActive, sortOrder])
  @@index([lookupTableId, value])
}

// Component template for auto-generating BOM items from field values
// Links ProductTypes, LookupTables, and ComponentLookups for unified product configuration
model ComponentTemplate {
  id                String    @id @default(cuid())
  tenantId          String
  name              String    // e.g., "Door Lipping", "Hinge Set", "Vision Glass"
  componentCategory String    // "material", "ironmongery", "glass", "finish", "hardware"
  description       String?
  
  // Link to global component library
  componentLookupId String?   // If set, creates instance of this ComponentLookup
  
  // Trigger conditions (for auto-generation from fields)
  requiredFields    String[]  // Fields that must have values to create component
  triggerFields     String[]  // Fields that trigger component creation/update
  
  // Lookup table linking (material/product selection)
  lookupTableId     String?   // Pulls pricing/specs from this lookup table
  lookupFieldName   String?   // Field name that contains the lookup value (e.g., "lippingMaterial")
  
  // Quantity calculation
  quantityFormula   String?   // Formula to calculate quantity (e.g., "leafHeight * 2 + leafWidth * 2")
  quantityUnit      String?   // Unit for calculated quantity
  
  // Field to component property mappings
  fieldMappings     Json      // { "lippingMaterial": "materialId", "leafHeight": "height" }
  
  // Default values
  defaultProps      Json?     // Default properties if not mapped from fields
  
  // AI/ML integration
  aiCategories      String[]  @default([]) // Categories AI should recognize (e.g., ["door", "window", "lipping"])
  aiKeywords        String[]  @default([]) // Keywords for AI matching (e.g., ["oak", "hinge", "glass"])
  
  // Product type linking (which product types use this template)
  productTypeIds    String[]  @default([]) // ProductType IDs this template applies to
  
  // Conditions
  activeWhen        Json?     // Conditions when this template should be active
  
  isActive          Boolean   @default(true)
  sortOrder         Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            Tenant    @relation("ComponentTemplates", fields: [tenantId], references: [id], onDelete: Cascade)
  lookupTable       LookupTable? @relation("TemplateLookupTable", fields: [lookupTableId], references: [id])
  componentLookup   ComponentLookup? @relation("TemplateComponentLookup", fields: [componentLookupId], references: [id])
  
  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@index([tenantId, componentCategory])
  @@index([componentLookupId])
}

// Field display context configuration
model FieldDisplayContext {
  id         String             @id @default(cuid())
  tenantId   String
  fieldId    String
  context    String
  isVisible  Boolean            @default(true)
  sortOrder  Int                @default(0)
  columnWidth Int?
  isFixed    Boolean            @default(false)
  showWhen   Json?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  
  field      QuestionnaireField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  tenant     Tenant             @relation("FieldDisplayContexts", fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, fieldId, context])
  @@index([tenantId, context])
  @@index([fieldId])
}

// ML Training event logging
model MLTrainingEvent {
  id                String   @id @default(cuid())
  tenantId          String
  eventType         String
  
  // Context
  leadId            String?
  quoteId           String?
  lineItemId        String?
  
  // Field data
  fieldId           String?
  fieldKey          String?
  fieldValue        Json?
  previousValue     Json?
  
  // Pricing data
  estimatedPrice    Decimal?
  quotedPrice       Decimal?
  acceptedPrice     Decimal?
  marginPercentage  Decimal?
  estimateAccuracy  Decimal?
  
  // Outcome tracking
  wasAccepted       Boolean?
  customerFeedback  String?
  
  // Full context snapshot
  contextSnapshot   Json
  
  // Metadata
  source            String?
  userId            String?
  createdAt         DateTime @default(now())
  
  tenant            Tenant   @relation("MLTrainingEvents", fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, eventType])
  @@index([tenantId, leadId])
  @@index([tenantId, quoteId])
  @@index([tenantId, createdAt])
  @@index([fieldId])
}

// Architect Pack Ingestion System

model ArchitectPack {
  id          String   @id @default(cuid())
  tenantId    String
  filename    String
  mime        String
  // Temporary base64 storage (swap to object storage later)
  base64Data  String?  @db.Text
  // Future: objectStorageKey String?
  // Future: objectStorageProvider String? (S3/Azure/etc)
  fileHash    String?  // SHA256 for caching
  fileSize    Int?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation("ArchitectPacks", fields: [tenantId], references: [id], onDelete: Cascade)
  analyses    ArchitectPackAnalysis[]
  
  @@index([tenantId, createdAt])
  @@index([fileHash])
}

model ArchitectPackAnalysis {
  id              String   @id @default(cuid())
  packId          String
  // Complete analysis JSON
  json            Json
  // AI model version for cache invalidation
  modelVersion    String   @default("v1")
  // Processing metadata
  pagesAnalyzed   Int?
  totalPages      Int?
  processingTime  Int?     // milliseconds
  createdAt       DateTime @default(now())
  
  pack            ArchitectPack          @relation(fields: [packId], references: [id], onDelete: Cascade)
  openings        ArchitectOpening[]
  
  @@index([packId])
  @@index([createdAt])
}

model ArchitectOpening {
  id              String   @id @default(cuid())
  analysisId      String
  // Opening details
  type            String   // 'door' | 'window' | 'screen' | 'sliding' | 'bifolding'
  widthMm         Int
  heightMm        Int
  // Location and context
  locationHint    String?  // e.g. "sunroom", "front entrance"
  pageNumber      Int?
  // Technical notes from AI
  notes           String?  @db.Text
  sillHeight      Int?
  glazingType     String?
  frameType       String?
  // AI confidence
  confidence      Float    @default(0.5)
  // User confirmation
  userConfirmed   Boolean  @default(false)
  userModified    Boolean  @default(false)
  // Link to quote line (once confirmed)
  quoteLineId     String?  @unique
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  analysis        ArchitectPackAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  quoteLine       QuoteLine?            @relation("ArchitectOpening", fields: [quoteLineId], references: [id], onDelete: SetNull)
  
  @@index([analysisId])
  @@index([userConfirmed])
  @@index([quoteLineId])
}

model TenantAIUsageEvent {
  id               String   @id @default(cuid())
  tenantId         String
  featureKey       String
  model            String
  inputType        String   // text | image | pdf | audio | other
  inputChars       Int?     // character count for text inputs
  imageCount       Int?     // number of images
  pdfPageCount     Int?     // number of pdf pages
  inputTokens      Int?     // prompt tokens
  outputTokens     Int?     // completion tokens
  estimatedCostUsd Float    @default(0)
  estimatedCostGbp Float    @default(0)
  currencyRate     Float    @default(0.79) // USD->GBP used for the estimate
  requestId        String   // correlate server/client logs
  metadata         Json?
  createdAt        DateTime @default(now())

  tenant           Tenant   @relation("TenantAIUsageEvents", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, featureKey])
  @@index([tenantId, createdAt])
}

model TenantAIUsageMonthly {
  id               String   @id @default(cuid())
  tenantId         String
  month            String   // YYYY-MM
  totalCostUsd     Float    @default(0)
  totalCostGbp     Float    @default(0)
  totalInputTokens Int      @default(0)
  totalOutputTokens Int     @default(0)
  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  tenant Tenant @relation("TenantAIUsageMonthly", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([tenantId])
}

model HolidayRequest {
  id          String    @id @default(cuid())
  tenantId    String
  userId      String
  startDate   DateTime
  endDate     DateTime
  days        Int       // Number of days requested
  reason      String?
  status      String    @default("pending") // pending | approved | denied
  adminNotes  String?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([userId, status])
}

// ============================================================================
// Sage Business Cloud Accounting Integration
// ============================================================================

model TenantAccountingConnection {
  id           String   @id @default(cuid())
  tenantId     String   
  provider     String   // 'sage', 'xero', 'quickbooks' etc
  status       String   @default("active") // 'active', 'disconnected', 'error'
  
  // OAuth tokens
  accessToken  String?  
  refreshToken String?
  expiresAt    DateTime?
  
  // Sage-specific fields
  scope        String?
  region       String?  // e.g. 'uk', 'us', 'ca'
  businessId   String?  // Sage business/company ID
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastSyncAt   DateTime?
  
  tenant       Tenant   @relation("AccountingConnections", fields: [tenantId], references: [id], onDelete: Cascade)
  documents    AccountingDocument[]
  
  @@unique([tenantId, provider])
  @@index([tenantId])
  @@index([status])
}

model AccountingDocument {
  id                   String    @id @default(cuid())
  tenantId             String
  connectionId         String
  provider             String    // 'sage'
  
  // External reference
  externalId           String    // Sage invoice/bill ID
  externalType         String    // 'sales_invoice', 'sales_credit', 'purchase_invoice', 'purchase_credit'
  
  // Document details
  documentNumber       String?
  referenceText        String?   // Where we look for order/project ref
  contactName          String?
  currency             String    @default("GBP")
  
  // Amounts
  total                Decimal   @default(0)
  tax                  Decimal   @default(0)
  net                  Decimal   @default(0)
  
  // Dates
  issueDate            DateTime?
  dueDate              DateTime?
  updatedAtExternal    DateTime?
  
  // Linking to JoineryAI entities
  linkedEntityType     String?   // 'opportunity', 'lead', null
  linkedEntityId       String?   // Opportunity.id or Lead.id
  autoLinked           Boolean   @default(false) // Was it auto-linked or manual?
  
  // Status from sage
  status               String?   // 'draft', 'posted', 'void' etc
  
  // Raw JSON for debugging
  rawJson              Json?
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  connection           TenantAccountingConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  tenant               Tenant    @relation("AccountingDocuments", fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, provider, externalId])
  @@index([tenantId, linkedEntityId])
  @@index([tenantId, externalType])
  @@index([tenantId, linkedEntityType, linkedEntityId])
  @@index([connectionId])
}

model MonthlyWageBill {
  id        String   @id @default(cuid())
  tenantId  String
  month     String   // Format: YYYY-MM
  wageBill  Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation("MonthlyWageBills", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([tenantId, month])
}

model MonthlyProjectMetrics {
  id                       String      @id @default(cuid())
  tenantId                 String
  projectId                String      // Opportunity.id
  month                    String      // Format: YYYY-MM
  
  // Hours tracking
  hoursThisMonth           Decimal     @default(0)
  hoursToDate              Decimal     @default(0)
  percentCompleteThisMonth Decimal     @default(0)
  percentCompleteToDate    Decimal     @default(0)
  
  // Financial breakdown
  revenueThisMonth         Decimal     @default(0)
  labourCostThisMonth      Decimal     @default(0)
  materialsCostThisMonth   Decimal     @default(0)
  totalCostThisMonth       Decimal     @default(0)
  grossProfitThisMonth     Decimal     @default(0)
  grossProfitPercent       Decimal     @default(0)
  
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  
  opportunity              Opportunity @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant                   Tenant      @relation("MonthlyProjectMetrics", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, projectId, month])
  @@index([tenantId, month])
  @@index([projectId, month])
}

model FireDoorRFI {
  id                  String                  @id @default(cuid())
  tenantId            String
  fireDoorLineItemId  String
  field               String // Which field has missing/unclear info
  question            String // What information is being requested
  status              String                  @default("open") // open, answered, closed
  priority            String                  @default("medium") // low, medium, high, urgent
  createdBy           String
  assignedTo          String?
  response            String?
  respondedAt         DateTime?
  resolvedAt          DateTime?
  visibleToCustomer   Boolean                 @default(true)
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  
  tenant              Tenant                  @relation("TenantFireDoorRFIs", fields: [tenantId], references: [id], onDelete: Cascade)
  lineItem            FireDoorScheduleProject @relation("FireDoorRFIs", fields: [fireDoorLineItemId], references: [id], onDelete: Cascade)
  creator             User                    @relation("RFICreator", fields: [createdBy], references: [id])
  assignee            User?                   @relation("RFIAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  
  @@index([tenantId, status])
  @@index([fireDoorLineItemId])
  @@index([tenantId, createdAt])
}

model GridFieldConfig {
  id              String    @id @default(cuid())
  fieldName       String    @unique
  inputType       String    @default("text") // text, number, dropdown, formula, date
  lookupTable     String?   // hinges, locks, glass, doorCore
  formula         String?   // Formula expression for calculated fields
  componentLink   String?   // hinges, locks, glass, doorBlank
  required        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([fieldName])
}

model FireDoorBOM {
  id            String      @id @default(cuid())
  fireDoorId    String      @unique
  tenantId      String
  productTypeId String
  bomData       Json        // Full GeneratedBOM structure with lineItems, pricing, etc.
  totalCost     Decimal     @db.Decimal(12, 2)
  itemCount     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  productType   ProductType @relation("ProductTypeFireDoorBOMs", fields: [productTypeId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([productTypeId])
  @@index([createdAt])
}
